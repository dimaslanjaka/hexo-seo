"use strict";
module.exports = Iterator;
var Object = require("./shim-object");
var GenericCollection = require("./generic-collection");
// upgrades an iterable to a Iterator
function Iterator(iterable, standardMode) {
    /*
        standardMode should be passed as true by a collection that uses Iterator
        to provide a polyfill of standard iterations methods like entries() and values(),
        as Collection's iterator behaves differently than standards ones when it comes to sparse arrays.
        without passing standardMode, new Iterator instances will behave as intended independently of standards.
    */
    var values = standardMode && iterable && iterable.values && iterable.values();
    if (values && typeof values.next === "function") {
        return values;
    }
    if (!(this instanceof Iterator)) {
        return new Iterator(iterable);
    }
    if (Array.isArray(iterable) || typeof iterable === "string")
        return Iterator.iterate(iterable);
    iterable = Object(iterable);
    if (iterable instanceof Iterator) {
        return iterable;
    }
    else if (iterable.next) {
        this.next = function () {
            return iterable.next();
        };
    }
    else if (iterable.iterate) {
        var iterator = iterable.iterate();
        this.next = function () {
            return iterator.next();
        };
    }
    else if (Object.prototype.toString.call(iterable) === "[object Function]") {
        this.next = iterable;
    }
    else {
        throw new TypeError("Can't iterate " + iterable);
    }
}
Iterator.prototype.forEach = GenericCollection.prototype.forEach;
Iterator.prototype.map = GenericCollection.prototype.map;
Iterator.prototype.filter = GenericCollection.prototype.filter;
Iterator.prototype.every = GenericCollection.prototype.every;
Iterator.prototype.some = GenericCollection.prototype.some;
Iterator.prototype.any = GenericCollection.prototype.any;
Iterator.prototype.all = GenericCollection.prototype.all;
Iterator.prototype.min = GenericCollection.prototype.min;
Iterator.prototype.max = GenericCollection.prototype.max;
Iterator.prototype.sum = GenericCollection.prototype.sum;
Iterator.prototype.average = GenericCollection.prototype.average;
Iterator.prototype.flatten = GenericCollection.prototype.flatten;
Iterator.prototype.zip = GenericCollection.prototype.zip;
Iterator.prototype.enumerate = GenericCollection.prototype.enumerate;
Iterator.prototype.sorted = GenericCollection.prototype.sorted;
Iterator.prototype.group = GenericCollection.prototype.group;
Iterator.prototype.reversed = GenericCollection.prototype.reversed;
Iterator.prototype.toArray = GenericCollection.prototype.toArray;
Iterator.prototype.toObject = GenericCollection.prototype.toObject;
Iterator.prototype.iterator = GenericCollection.prototype.iterator;
Iterator.prototype.__iterationObject = null;
Object.defineProperty(Iterator.prototype, "_iterationObject", {
    get: function () {
        return this.__iterationObject || (this.__iterationObject = { done: false, value: void 0 });
    }
});
// this is a bit of a cheat so flatten and such work with the generic
// reducible
Iterator.prototype.constructClone = function (values) {
    var clone = [];
    clone.addEach(values);
    return clone;
};
Iterator.prototype.mapIterator = function (callback /*, thisp*/) {
    var self = Iterator(this), thisp = arguments[1], i = 0;
    if (Object.prototype.toString.call(callback) != "[object Function]")
        throw new TypeError();
    return new self.constructor(function () {
        if (self._iterationObject.done !== true) {
            var callbackValue = callback.call(thisp, self.next().value, i++, self);
            self._iterationObject.value = callbackValue;
        }
        return self._iterationObject;
    });
};
Iterator.prototype.filterIterator = function (callback /*, thisp*/) {
    var self = Iterator(this), thisp = arguments[1], i = 0;
    if (Object.prototype.toString.call(callback) != "[object Function]")
        throw new TypeError();
    return new self.constructor(function () {
        var nextEntry;
        while (true) {
            nextEntry = self.next();
            if (nextEntry.done !== true) {
                if (callback.call(thisp, nextEntry.value, i++, self))
                    return nextEntry;
            }
            else {
                //done true and value undefined at this point
                return nextEntry;
            }
        }
    });
};
Iterator.prototype.reduce = function (callback /*, initial, thisp*/) {
    var self = Iterator(this), result = arguments[1], thisp = arguments[2], i = 0, nextEntry;
    if (Object.prototype.toString.call(callback) != "[object Function]")
        throw new TypeError();
    // first iteration unrolled
    nextEntry = self.next();
    if (nextEntry.done === true) {
        if (arguments.length > 1) {
            return arguments[1]; // initial
        }
        else {
            throw TypeError("cannot reduce a value from an empty iterator with no initial value");
        }
    }
    if (arguments.length > 1) {
        result = callback.call(thisp, result, nextEntry.value, i, self);
    }
    else {
        result = nextEntry.value;
    }
    i++;
    // remaining entries
    while (true) {
        nextEntry = self.next();
        if (nextEntry.done === true) {
            return result;
        }
        result = callback.call(thisp, result, nextEntry.value, i, self);
        i++;
    }
};
Iterator.prototype.concat = function () {
    return Iterator.concat(Array.prototype.concat.apply(this, arguments));
};
Iterator.prototype.dropWhile = function (callback /*, thisp */) {
    var self = Iterator(this), thisp = arguments[1], stopped = false, stopValue, nextEntry, i = 0;
    if (Object.prototype.toString.call(callback) != "[object Function]")
        throw new TypeError();
    while (true) {
        nextEntry = self.next();
        if (nextEntry.done === true) {
            break;
        }
        if (!callback.call(thisp, nextEntry.value, i, self)) {
            stopped = true;
            stopValue = nextEntry.value;
            break;
        }
        i++;
    }
    if (stopped) {
        return self.constructor([stopValue]).concat(self);
    }
    else {
        return self.constructor([]);
    }
};
Iterator.prototype.takeWhile = function (callback /*, thisp*/) {
    var self = Iterator(this), thisp = arguments[1], nextEntry, i = 0;
    if (Object.prototype.toString.call(callback) != "[object Function]")
        throw new TypeError();
    return new self.constructor(function () {
        if (self._iterationObject.done !== true) {
            var value = self.next().value;
            if (callback.call(thisp, value, i++, self)) {
                self._iterationObject.value = value;
            }
            else {
                self._iterationObject.done = true;
                self._iterationObject.value = void 0;
            }
        }
        return self._iterationObject;
    });
};
Iterator.prototype.zipIterator = function () {
    return Iterator.unzip(Array.prototype.concat.apply(this, arguments));
};
Iterator.prototype.enumerateIterator = function (start) {
    return Iterator.count(start).zipIterator(this);
};
// creates an iterator for Array and String
Iterator.iterate = function (iterable) {
    var start;
    start = 0;
    return new Iterator(function () {
        // advance to next owned entry
        if (typeof iterable === "object") {
            while (!(start in iterable)) {
                // deliberately late bound
                if (start >= iterable.length) {
                    this._iterationObject.done = true;
                    this._iterationObject.value = void 0;
                    break;
                }
                else
                    start += 1;
            }
        }
        else if (start >= iterable.length) {
            this._iterationObject.done = true;
            this._iterationObject.value = void 0;
        }
        if (!this._iterationObject.done) {
            this._iterationObject.value = iterable[start];
            start += 1;
        }
        return this._iterationObject;
    });
};
Iterator.cycle = function (cycle, times) {
    var next;
    if (arguments.length < 2)
        times = Infinity;
    //cycle = Iterator(cycle).toArray();
    return new Iterator(function () {
        var iteration, nextEntry;
        if (next) {
            nextEntry = next();
        }
        if (!next || nextEntry.done === true) {
            if (times > 0) {
                times--;
                iteration = Iterator.iterate(cycle);
                nextEntry = (next = iteration.next.bind(iteration))();
            }
            else {
                this._iterationObject.done = true;
                nextEntry = this._iterationObject;
            }
        }
        return nextEntry;
    });
};
Iterator.concat = function (iterators) {
    iterators = Iterator(iterators);
    var next;
    return new Iterator(function () {
        var iteration, nextEntry;
        if (next)
            nextEntry = next();
        if (!nextEntry || nextEntry.done === true) {
            nextEntry = iterators.next();
            if (nextEntry.done === false) {
                iteration = Iterator(nextEntry.value);
                next = iteration.next.bind(iteration);
                return next();
            }
            else {
                return nextEntry;
            }
        }
        else
            return nextEntry;
    });
};
Iterator.unzip = function (iterators) {
    iterators = Iterator(iterators).map(Iterator);
    if (iterators.length === 0)
        return new Iterator([]);
    return new Iterator(function () {
        var stopped, nextEntry;
        var result = iterators.map(function (iterator) {
            nextEntry = iterator.next();
            if (nextEntry.done === true) {
                stopped = true;
            }
            return nextEntry.value;
        });
        if (stopped) {
            this._iterationObject.done = true;
            this._iterationObject.value = void 0;
        }
        else {
            this._iterationObject.value = result;
        }
        return this._iterationObject;
    });
};
Iterator.zip = function () {
    return Iterator.unzip(Array.prototype.slice.call(arguments));
};
Iterator.chain = function () {
    return Iterator.concat(Array.prototype.slice.call(arguments));
};
Iterator.range = function (start, stop, step) {
    if (arguments.length < 3) {
        step = 1;
    }
    if (arguments.length < 2) {
        stop = start;
        start = 0;
    }
    start = start || 0;
    step = step || 1;
    return new Iterator(function () {
        if (start >= stop) {
            this._iterationObject.done = true;
            this._iterationObject.value = void 0;
        }
        var result = start;
        start += step;
        this._iterationObject.value = result;
        return this._iterationObject;
    });
};
Iterator.count = function (start, step) {
    return Iterator.range(start, Infinity, step);
};
Iterator.repeat = function (value, times) {
    return new Iterator.range(times).mapIterator(function () {
        return value;
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlcmF0b3IuanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2pzLXByb3RvdHlwZXMvcGFja2FnZXMvY29sbGVjdGlvbnMvaXRlcmF0b3IuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsTUFBTSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUM7QUFFMUIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3RDLElBQUksaUJBQWlCLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFFeEQscUNBQXFDO0FBQ3JDLFNBQVMsUUFBUSxDQUFDLFFBQVEsRUFBRSxZQUFZO0lBRXBDOzs7OztNQUtFO0lBQ0YsSUFBSSxNQUFNLEdBQUcsWUFBWSxJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUM5RSxJQUFHLE1BQU0sSUFBSSxPQUFPLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxFQUFHO1FBQzdDLE9BQU8sTUFBTSxDQUFDO0tBQ2pCO0lBRUQsSUFBSSxDQUFDLENBQUMsSUFBSSxZQUFZLFFBQVEsQ0FBQyxFQUFFO1FBQzdCLE9BQU8sSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7S0FDakM7SUFFRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksT0FBTyxRQUFRLEtBQUssUUFBUTtRQUN2RCxPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFdEMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUU1QixJQUFJLFFBQVEsWUFBWSxRQUFRLEVBQUU7UUFDOUIsT0FBTyxRQUFRLENBQUM7S0FDbkI7U0FBTSxJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUU7UUFDdEIsSUFBSSxDQUFDLElBQUksR0FBRztZQUNSLE9BQU8sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzNCLENBQUMsQ0FBQztLQUNMO1NBQU0sSUFBSSxRQUFRLENBQUMsT0FBTyxFQUFFO1FBQ3pCLElBQUksUUFBUSxHQUFHLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNsQyxJQUFJLENBQUMsSUFBSSxHQUFHO1lBQ1IsT0FBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDM0IsQ0FBQyxDQUFDO0tBQ0w7U0FBTSxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxtQkFBbUIsRUFBRTtRQUN6RSxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQztLQUN4QjtTQUFNO1FBQ0gsTUFBTSxJQUFJLFNBQVMsQ0FBQyxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsQ0FBQztLQUNwRDtBQUVMLENBQUM7QUFFRCxRQUFRLENBQUMsU0FBUyxDQUFDLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDO0FBQ2pFLFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRyxHQUFHLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUM7QUFDekQsUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQztBQUMvRCxRQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO0FBQzdELFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxHQUFHLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7QUFDM0QsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQztBQUN6RCxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDO0FBQ3pELFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRyxHQUFHLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUM7QUFDekQsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQztBQUN6RCxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDO0FBQ3pELFFBQVEsQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7QUFDakUsUUFBUSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQztBQUNqRSxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDO0FBQ3pELFFBQVEsQ0FBQyxTQUFTLENBQUMsU0FBUyxHQUFHLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUM7QUFDckUsUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQztBQUMvRCxRQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO0FBQzdELFFBQVEsQ0FBQyxTQUFTLENBQUMsUUFBUSxHQUFHLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7QUFDbkUsUUFBUSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQztBQUNqRSxRQUFRLENBQUMsU0FBUyxDQUFDLFFBQVEsR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO0FBQ25FLFFBQVEsQ0FBQyxTQUFTLENBQUMsUUFBUSxHQUFHLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7QUFFbkUsUUFBUSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7QUFDNUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFDLGtCQUFrQixFQUFFO0lBQ3pELEdBQUcsRUFBRTtRQUNELE9BQU8sSUFBSSxDQUFDLGlCQUFpQixJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUMsS0FBSyxDQUFDLEVBQUMsQ0FBQyxDQUFDO0lBQzdGLENBQUM7Q0FDSixDQUFDLENBQUM7QUFHSCxxRUFBcUU7QUFDckUsWUFBWTtBQUNaLFFBQVEsQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLFVBQVUsTUFBTTtJQUNoRCxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7SUFDZixLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RCLE9BQU8sS0FBSyxDQUFDO0FBQ2pCLENBQUMsQ0FBQztBQUVGLFFBQVEsQ0FBQyxTQUFTLENBQUMsV0FBVyxHQUFHLFVBQVUsUUFBUSxDQUFDLFdBQVc7SUFDM0QsSUFBSSxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUNyQixLQUFLLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUNwQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRVYsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksbUJBQW1CO1FBQy9ELE1BQU0sSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUUxQixPQUFPLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUN4QixJQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ3BDLElBQUksYUFBYSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDdkUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssR0FBRyxhQUFhLENBQUM7U0FDL0M7UUFDRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUNqQyxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQUVGLFFBQVEsQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLFVBQVUsUUFBUSxDQUFDLFdBQVc7SUFDOUQsSUFBSSxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUNyQixLQUFLLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUNwQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRVYsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksbUJBQW1CO1FBQy9ELE1BQU0sSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUUxQixPQUFPLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUN4QixJQUFJLFNBQVMsQ0FBQztRQUNkLE9BQU8sSUFBSSxFQUFFO1lBQ1QsU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN4QixJQUFHLFNBQVMsQ0FBQyxJQUFJLEtBQUssSUFBSSxFQUFFO2dCQUN4QixJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDO29CQUNoRCxPQUFPLFNBQVMsQ0FBQzthQUN4QjtpQkFDSTtnQkFDRCw2Q0FBNkM7Z0JBQzdDLE9BQU8sU0FBUyxDQUFDO2FBQ3BCO1NBQ0o7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQUVGLFFBQVEsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLFVBQVUsUUFBUSxDQUFDLG9CQUFvQjtJQUMvRCxJQUFJLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQ3JCLE1BQU0sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQ3JCLEtBQUssR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQ3BCLENBQUMsR0FBRyxDQUFDLEVBQ0wsU0FBUyxDQUFDO0lBRWQsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksbUJBQW1CO1FBQy9ELE1BQU0sSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUUxQiwyQkFBMkI7SUFDM0IsU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN4QixJQUFHLFNBQVMsQ0FBQyxJQUFJLEtBQUssSUFBSSxFQUFFO1FBQ3hCLElBQUksU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdEIsT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVO1NBQ2xDO2FBQU07WUFDSCxNQUFNLFNBQVMsQ0FBQyxvRUFBb0UsQ0FBQyxDQUFDO1NBQ3pGO0tBQ0o7SUFDRCxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ3RCLE1BQU0sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDbkU7U0FBTTtRQUNILE1BQU0sR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDO0tBQzVCO0lBQ0QsQ0FBQyxFQUFFLENBQUM7SUFDSixvQkFBb0I7SUFDcEIsT0FBTyxJQUFJLEVBQUU7UUFDVCxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3hCLElBQUcsU0FBUyxDQUFDLElBQUksS0FBSyxJQUFJLEVBQUU7WUFDeEIsT0FBTyxNQUFNLENBQUM7U0FDakI7UUFDRCxNQUFNLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hFLENBQUMsRUFBRSxDQUFDO0tBQ1A7QUFFTCxDQUFDLENBQUM7QUFFRixRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRztJQUN4QixPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQ2xCLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQ2hELENBQUM7QUFDTixDQUFDLENBQUM7QUFFRixRQUFRLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxVQUFVLFFBQVEsQ0FBQyxZQUFZO0lBQzFELElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFDckIsS0FBSyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFDcEIsT0FBTyxHQUFHLEtBQUssRUFDZixTQUFTLEVBQ1QsU0FBUyxFQUNULENBQUMsR0FBRyxDQUFDLENBQUM7SUFFVixJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxtQkFBbUI7UUFDL0QsTUFBTSxJQUFJLFNBQVMsRUFBRSxDQUFDO0lBRTFCLE9BQU8sSUFBSSxFQUFFO1FBQ1QsU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN4QixJQUFHLFNBQVMsQ0FBQyxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ3hCLE1BQU07U0FDVDtRQUNELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRTtZQUNqRCxPQUFPLEdBQUcsSUFBSSxDQUFDO1lBQ2YsU0FBUyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUM7WUFDNUIsTUFBTTtTQUNUO1FBQ0QsQ0FBQyxFQUFFLENBQUM7S0FDUDtJQUVELElBQUksT0FBTyxFQUFFO1FBQ1QsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDckQ7U0FBTTtRQUNILE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUMvQjtBQUNMLENBQUMsQ0FBQztBQUVGLFFBQVEsQ0FBQyxTQUFTLENBQUMsU0FBUyxHQUFHLFVBQVUsUUFBUSxDQUFDLFdBQVc7SUFDekQsSUFBSSxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUNyQixLQUFLLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUNwQixTQUFTLEVBQ1QsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUVWLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLG1CQUFtQjtRQUMvRCxNQUFNLElBQUksU0FBUyxFQUFFLENBQUM7SUFFMUIsT0FBTyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDeEIsSUFBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxLQUFLLElBQUksRUFBRTtZQUNwQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDO1lBQzlCLElBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFO2dCQUN2QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQzthQUN2QztpQkFDSTtnQkFDRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztnQkFDbEMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQzthQUN4QztTQUNKO1FBQ0QsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7SUFDakMsQ0FBQyxDQUFDLENBQUM7QUFFUCxDQUFDLENBQUM7QUFFRixRQUFRLENBQUMsU0FBUyxDQUFDLFdBQVcsR0FBRztJQUM3QixPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQ2pCLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQ2hELENBQUM7QUFDTixDQUFDLENBQUM7QUFFRixRQUFRLENBQUMsU0FBUyxDQUFDLGlCQUFpQixHQUFHLFVBQVUsS0FBSztJQUNsRCxPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ25ELENBQUMsQ0FBQztBQUVGLDJDQUEyQztBQUMzQyxRQUFRLENBQUMsT0FBTyxHQUFHLFVBQVUsUUFBUTtJQUNqQyxJQUFJLEtBQUssQ0FBQztJQUNWLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDVixPQUFPLElBQUksUUFBUSxDQUFDO1FBQ2hCLDhCQUE4QjtRQUM5QixJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVEsRUFBRTtZQUM5QixPQUFPLENBQUMsQ0FBQyxLQUFLLElBQUksUUFBUSxDQUFDLEVBQUU7Z0JBQ3pCLDBCQUEwQjtnQkFDMUIsSUFBSSxLQUFLLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRTtvQkFDMUIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7b0JBQ2xDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUM7b0JBQ3JDLE1BQU07aUJBQ1Q7O29CQUNJLEtBQUssSUFBSSxDQUFDLENBQUM7YUFDbkI7U0FDSjthQUFNLElBQUksS0FBSyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUU7WUFDakMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7WUFDbEMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQztTQUN4QztRQUVELElBQUcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFO1lBQzVCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzlDLEtBQUssSUFBSSxDQUFDLENBQUM7U0FDZDtRQUNELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDO0lBQ2pDLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDO0FBRUYsUUFBUSxDQUFDLEtBQUssR0FBRyxVQUFVLEtBQUssRUFBRSxLQUFLO0lBQ25DLElBQUksSUFBSSxDQUFDO0lBQ1QsSUFBSSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUM7UUFDcEIsS0FBSyxHQUFHLFFBQVEsQ0FBQztJQUNyQixvQ0FBb0M7SUFDcEMsT0FBTyxJQUFJLFFBQVEsQ0FBQztRQUNoQixJQUFJLFNBQVMsRUFBRSxTQUFTLENBQUM7UUFFekIsSUFBRyxJQUFJLEVBQUU7WUFDTCxTQUFTLEdBQUcsSUFBSSxFQUFFLENBQUM7U0FDdEI7UUFFRCxJQUFHLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQyxJQUFJLEtBQUssSUFBSSxFQUFFO1lBQ2pDLElBQUksS0FBSyxHQUFHLENBQUMsRUFBRTtnQkFDWCxLQUFLLEVBQUUsQ0FBQztnQkFDUixTQUFTLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDcEMsU0FBUyxHQUFHLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQzthQUN6RDtpQkFDSTtnQkFDRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztnQkFDbEMsU0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQzthQUFhO1NBQ3REO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUM7QUFFRixRQUFRLENBQUMsTUFBTSxHQUFHLFVBQVUsU0FBUztJQUNqQyxTQUFTLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2hDLElBQUksSUFBSSxDQUFDO0lBQ1QsT0FBTyxJQUFJLFFBQVEsQ0FBQztRQUNoQixJQUFJLFNBQVMsRUFBRSxTQUFTLENBQUM7UUFDekIsSUFBRyxJQUFJO1lBQUUsU0FBUyxHQUFHLElBQUksRUFBRSxDQUFDO1FBQzVCLElBQUcsQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLElBQUksS0FBSyxJQUFJLEVBQUU7WUFDdEMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUM3QixJQUFHLFNBQVMsQ0FBQyxJQUFJLEtBQUssS0FBSyxFQUFFO2dCQUN6QixTQUFTLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDdEMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN0QyxPQUFPLElBQUksRUFBRSxDQUFDO2FBQ2pCO2lCQUNJO2dCQUNELE9BQU8sU0FBUyxDQUFDO2FBQ3BCO1NBQ0o7O1lBQ0ksT0FBTyxTQUFTLENBQUM7SUFDMUIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUM7QUFFRixRQUFRLENBQUMsS0FBSyxHQUFHLFVBQVUsU0FBUztJQUNoQyxTQUFTLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM5QyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQztRQUN0QixPQUFPLElBQUksUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzVCLE9BQU8sSUFBSSxRQUFRLENBQUM7UUFDaEIsSUFBSSxPQUFPLEVBQUUsU0FBUyxDQUFDO1FBQ3ZCLElBQUksTUFBTSxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxRQUFRO1lBQ3pDLFNBQVMsR0FBRyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDNUIsSUFBSSxTQUFTLENBQUMsSUFBSSxLQUFLLElBQUksRUFBRztnQkFDMUIsT0FBTyxHQUFHLElBQUksQ0FBQzthQUNsQjtZQUNELE9BQU8sU0FBUyxDQUFDLEtBQUssQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FBQztRQUNILElBQUksT0FBTyxFQUFFO1lBQ1QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7WUFDbEMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQztTQUN4QzthQUNJO1lBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssR0FBRyxNQUFNLENBQUM7U0FDeEM7UUFDRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztJQUNqQyxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQUVGLFFBQVEsQ0FBQyxHQUFHLEdBQUc7SUFDWCxPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQ2pCLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FDeEMsQ0FBQztBQUNOLENBQUMsQ0FBQztBQUVGLFFBQVEsQ0FBQyxLQUFLLEdBQUc7SUFDYixPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQ2xCLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FDeEMsQ0FBQztBQUNOLENBQUMsQ0FBQztBQUVGLFFBQVEsQ0FBQyxLQUFLLEdBQUcsVUFBVSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUk7SUFDeEMsSUFBSSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUN0QixJQUFJLEdBQUcsQ0FBQyxDQUFDO0tBQ1o7SUFDRCxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ3RCLElBQUksR0FBRyxLQUFLLENBQUM7UUFDYixLQUFLLEdBQUcsQ0FBQyxDQUFDO0tBQ2I7SUFDRCxLQUFLLEdBQUcsS0FBSyxJQUFJLENBQUMsQ0FBQztJQUNuQixJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQztJQUNqQixPQUFPLElBQUksUUFBUSxDQUFDO1FBQ2hCLElBQUksS0FBSyxJQUFJLElBQUksRUFBRTtZQUNmLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUM7U0FDeEM7UUFDRCxJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUM7UUFDbkIsS0FBSyxJQUFJLElBQUksQ0FBQztRQUNkLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDO1FBRXJDLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDO0lBQ2pDLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDO0FBRUYsUUFBUSxDQUFDLEtBQUssR0FBRyxVQUFVLEtBQUssRUFBRSxJQUFJO0lBQ2xDLE9BQU8sUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ2pELENBQUMsQ0FBQztBQUVGLFFBQVEsQ0FBQyxNQUFNLEdBQUcsVUFBVSxLQUFLLEVBQUUsS0FBSztJQUNwQyxPQUFPLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxXQUFXLENBQUM7UUFDekMsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxubW9kdWxlLmV4cG9ydHMgPSBJdGVyYXRvcjtcblxudmFyIE9iamVjdCA9IHJlcXVpcmUoXCIuL3NoaW0tb2JqZWN0XCIpO1xudmFyIEdlbmVyaWNDb2xsZWN0aW9uID0gcmVxdWlyZShcIi4vZ2VuZXJpYy1jb2xsZWN0aW9uXCIpO1xuXG4vLyB1cGdyYWRlcyBhbiBpdGVyYWJsZSB0byBhIEl0ZXJhdG9yXG5mdW5jdGlvbiBJdGVyYXRvcihpdGVyYWJsZSwgc3RhbmRhcmRNb2RlKSB7XG5cbiAgICAvKlxuICAgICAgICBzdGFuZGFyZE1vZGUgc2hvdWxkIGJlIHBhc3NlZCBhcyB0cnVlIGJ5IGEgY29sbGVjdGlvbiB0aGF0IHVzZXMgSXRlcmF0b3JcbiAgICAgICAgdG8gcHJvdmlkZSBhIHBvbHlmaWxsIG9mIHN0YW5kYXJkIGl0ZXJhdGlvbnMgbWV0aG9kcyBsaWtlIGVudHJpZXMoKSBhbmQgdmFsdWVzKCksXG4gICAgICAgIGFzIENvbGxlY3Rpb24ncyBpdGVyYXRvciBiZWhhdmVzIGRpZmZlcmVudGx5IHRoYW4gc3RhbmRhcmRzIG9uZXMgd2hlbiBpdCBjb21lcyB0byBzcGFyc2UgYXJyYXlzLlxuICAgICAgICB3aXRob3V0IHBhc3Npbmcgc3RhbmRhcmRNb2RlLCBuZXcgSXRlcmF0b3IgaW5zdGFuY2VzIHdpbGwgYmVoYXZlIGFzIGludGVuZGVkIGluZGVwZW5kZW50bHkgb2Ygc3RhbmRhcmRzLlxuICAgICovXG4gICAgdmFyIHZhbHVlcyA9IHN0YW5kYXJkTW9kZSAmJiBpdGVyYWJsZSAmJiBpdGVyYWJsZS52YWx1ZXMgJiYgaXRlcmFibGUudmFsdWVzKCk7XG4gICAgaWYodmFsdWVzICYmIHR5cGVvZiB2YWx1ZXMubmV4dCA9PT0gXCJmdW5jdGlvblwiICkge1xuICAgICAgICByZXR1cm4gdmFsdWVzO1xuICAgIH1cblxuICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBJdGVyYXRvcikpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBJdGVyYXRvcihpdGVyYWJsZSk7XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlcmFibGUpIHx8IHR5cGVvZiBpdGVyYWJsZSA9PT0gXCJzdHJpbmdcIilcbiAgICAgICAgcmV0dXJuIEl0ZXJhdG9yLml0ZXJhdGUoaXRlcmFibGUpO1xuXG4gICAgaXRlcmFibGUgPSBPYmplY3QoaXRlcmFibGUpO1xuXG4gICAgaWYgKGl0ZXJhYmxlIGluc3RhbmNlb2YgSXRlcmF0b3IpIHtcbiAgICAgICAgcmV0dXJuIGl0ZXJhYmxlO1xuICAgIH0gZWxzZSBpZiAoaXRlcmFibGUubmV4dCkge1xuICAgICAgICB0aGlzLm5leHQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gaXRlcmFibGUubmV4dCgpO1xuICAgICAgICB9O1xuICAgIH0gZWxzZSBpZiAoaXRlcmFibGUuaXRlcmF0ZSkge1xuICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYWJsZS5pdGVyYXRlKCk7XG4gICAgICAgIHRoaXMubmV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBpdGVyYXRvci5uZXh0KCk7XG4gICAgICAgIH07XG4gICAgfSBlbHNlIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaXRlcmFibGUpID09PSBcIltvYmplY3QgRnVuY3Rpb25dXCIpIHtcbiAgICAgICAgdGhpcy5uZXh0ID0gaXRlcmFibGU7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkNhbid0IGl0ZXJhdGUgXCIgKyBpdGVyYWJsZSk7XG4gICAgfVxuXG59XG5cbkl0ZXJhdG9yLnByb3RvdHlwZS5mb3JFYWNoID0gR2VuZXJpY0NvbGxlY3Rpb24ucHJvdG90eXBlLmZvckVhY2g7XG5JdGVyYXRvci5wcm90b3R5cGUubWFwID0gR2VuZXJpY0NvbGxlY3Rpb24ucHJvdG90eXBlLm1hcDtcbkl0ZXJhdG9yLnByb3RvdHlwZS5maWx0ZXIgPSBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUuZmlsdGVyO1xuSXRlcmF0b3IucHJvdG90eXBlLmV2ZXJ5ID0gR2VuZXJpY0NvbGxlY3Rpb24ucHJvdG90eXBlLmV2ZXJ5O1xuSXRlcmF0b3IucHJvdG90eXBlLnNvbWUgPSBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUuc29tZTtcbkl0ZXJhdG9yLnByb3RvdHlwZS5hbnkgPSBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUuYW55O1xuSXRlcmF0b3IucHJvdG90eXBlLmFsbCA9IEdlbmVyaWNDb2xsZWN0aW9uLnByb3RvdHlwZS5hbGw7XG5JdGVyYXRvci5wcm90b3R5cGUubWluID0gR2VuZXJpY0NvbGxlY3Rpb24ucHJvdG90eXBlLm1pbjtcbkl0ZXJhdG9yLnByb3RvdHlwZS5tYXggPSBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUubWF4O1xuSXRlcmF0b3IucHJvdG90eXBlLnN1bSA9IEdlbmVyaWNDb2xsZWN0aW9uLnByb3RvdHlwZS5zdW07XG5JdGVyYXRvci5wcm90b3R5cGUuYXZlcmFnZSA9IEdlbmVyaWNDb2xsZWN0aW9uLnByb3RvdHlwZS5hdmVyYWdlO1xuSXRlcmF0b3IucHJvdG90eXBlLmZsYXR0ZW4gPSBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUuZmxhdHRlbjtcbkl0ZXJhdG9yLnByb3RvdHlwZS56aXAgPSBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUuemlwO1xuSXRlcmF0b3IucHJvdG90eXBlLmVudW1lcmF0ZSA9IEdlbmVyaWNDb2xsZWN0aW9uLnByb3RvdHlwZS5lbnVtZXJhdGU7XG5JdGVyYXRvci5wcm90b3R5cGUuc29ydGVkID0gR2VuZXJpY0NvbGxlY3Rpb24ucHJvdG90eXBlLnNvcnRlZDtcbkl0ZXJhdG9yLnByb3RvdHlwZS5ncm91cCA9IEdlbmVyaWNDb2xsZWN0aW9uLnByb3RvdHlwZS5ncm91cDtcbkl0ZXJhdG9yLnByb3RvdHlwZS5yZXZlcnNlZCA9IEdlbmVyaWNDb2xsZWN0aW9uLnByb3RvdHlwZS5yZXZlcnNlZDtcbkl0ZXJhdG9yLnByb3RvdHlwZS50b0FycmF5ID0gR2VuZXJpY0NvbGxlY3Rpb24ucHJvdG90eXBlLnRvQXJyYXk7XG5JdGVyYXRvci5wcm90b3R5cGUudG9PYmplY3QgPSBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUudG9PYmplY3Q7XG5JdGVyYXRvci5wcm90b3R5cGUuaXRlcmF0b3IgPSBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUuaXRlcmF0b3I7XG5cbkl0ZXJhdG9yLnByb3RvdHlwZS5fX2l0ZXJhdGlvbk9iamVjdCA9IG51bGw7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoSXRlcmF0b3IucHJvdG90eXBlLFwiX2l0ZXJhdGlvbk9iamVjdFwiLCB7XG4gICAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX19pdGVyYXRpb25PYmplY3QgfHwgKHRoaXMuX19pdGVyYXRpb25PYmplY3QgPSB7IGRvbmU6IGZhbHNlLCB2YWx1ZTp2b2lkIDB9KTtcbiAgICB9XG59KTtcblxuXG4vLyB0aGlzIGlzIGEgYml0IG9mIGEgY2hlYXQgc28gZmxhdHRlbiBhbmQgc3VjaCB3b3JrIHdpdGggdGhlIGdlbmVyaWNcbi8vIHJlZHVjaWJsZVxuSXRlcmF0b3IucHJvdG90eXBlLmNvbnN0cnVjdENsb25lID0gZnVuY3Rpb24gKHZhbHVlcykge1xuICAgIHZhciBjbG9uZSA9IFtdO1xuICAgIGNsb25lLmFkZEVhY2godmFsdWVzKTtcbiAgICByZXR1cm4gY2xvbmU7XG59O1xuXG5JdGVyYXRvci5wcm90b3R5cGUubWFwSXRlcmF0b3IgPSBmdW5jdGlvbiAoY2FsbGJhY2sgLyosIHRoaXNwKi8pIHtcbiAgICB2YXIgc2VsZiA9IEl0ZXJhdG9yKHRoaXMpLFxuICAgICAgICB0aGlzcCA9IGFyZ3VtZW50c1sxXSxcbiAgICAgICAgaSA9IDA7XG5cbiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGNhbGxiYWNrKSAhPSBcIltvYmplY3QgRnVuY3Rpb25dXCIpXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoKTtcblxuICAgIHJldHVybiBuZXcgc2VsZi5jb25zdHJ1Y3RvcihmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmKHNlbGYuX2l0ZXJhdGlvbk9iamVjdC5kb25lICE9PSB0cnVlKSB7XG4gICAgICAgICAgICB2YXIgY2FsbGJhY2tWYWx1ZSA9IGNhbGxiYWNrLmNhbGwodGhpc3AsIHNlbGYubmV4dCgpLnZhbHVlLCBpKyssIHNlbGYpO1xuICAgICAgICAgICAgc2VsZi5faXRlcmF0aW9uT2JqZWN0LnZhbHVlID0gY2FsbGJhY2tWYWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2VsZi5faXRlcmF0aW9uT2JqZWN0O1xuICAgIH0pO1xufTtcblxuSXRlcmF0b3IucHJvdG90eXBlLmZpbHRlckl0ZXJhdG9yID0gZnVuY3Rpb24gKGNhbGxiYWNrIC8qLCB0aGlzcCovKSB7XG4gICAgdmFyIHNlbGYgPSBJdGVyYXRvcih0aGlzKSxcbiAgICAgICAgdGhpc3AgPSBhcmd1bWVudHNbMV0sXG4gICAgICAgIGkgPSAwO1xuXG4gICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjYWxsYmFjaykgIT0gXCJbb2JqZWN0IEZ1bmN0aW9uXVwiKVxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7XG5cbiAgICByZXR1cm4gbmV3IHNlbGYuY29uc3RydWN0b3IoZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgbmV4dEVudHJ5O1xuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgbmV4dEVudHJ5ID0gc2VsZi5uZXh0KCk7XG4gICAgICAgICAgICBpZihuZXh0RW50cnkuZG9uZSAhPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjay5jYWxsKHRoaXNwLCBuZXh0RW50cnkudmFsdWUsIGkrKywgc2VsZikpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0RW50cnk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAvL2RvbmUgdHJ1ZSBhbmQgdmFsdWUgdW5kZWZpbmVkIGF0IHRoaXMgcG9pbnRcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dEVudHJ5O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG59O1xuXG5JdGVyYXRvci5wcm90b3R5cGUucmVkdWNlID0gZnVuY3Rpb24gKGNhbGxiYWNrIC8qLCBpbml0aWFsLCB0aGlzcCovKSB7XG4gICAgdmFyIHNlbGYgPSBJdGVyYXRvcih0aGlzKSxcbiAgICAgICAgcmVzdWx0ID0gYXJndW1lbnRzWzFdLFxuICAgICAgICB0aGlzcCA9IGFyZ3VtZW50c1syXSxcbiAgICAgICAgaSA9IDAsXG4gICAgICAgIG5leHRFbnRyeTtcblxuICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY2FsbGJhY2spICE9IFwiW29iamVjdCBGdW5jdGlvbl1cIilcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigpO1xuXG4gICAgLy8gZmlyc3QgaXRlcmF0aW9uIHVucm9sbGVkXG4gICAgbmV4dEVudHJ5ID0gc2VsZi5uZXh0KCk7XG4gICAgaWYobmV4dEVudHJ5LmRvbmUgPT09IHRydWUpIHtcbiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzWzFdOyAvLyBpbml0aWFsXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoXCJjYW5ub3QgcmVkdWNlIGEgdmFsdWUgZnJvbSBhbiBlbXB0eSBpdGVyYXRvciB3aXRoIG5vIGluaXRpYWwgdmFsdWVcIik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwodGhpc3AsIHJlc3VsdCwgbmV4dEVudHJ5LnZhbHVlLCBpLCBzZWxmKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQgPSBuZXh0RW50cnkudmFsdWU7XG4gICAgfVxuICAgIGkrKztcbiAgICAvLyByZW1haW5pbmcgZW50cmllc1xuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgIG5leHRFbnRyeSA9IHNlbGYubmV4dCgpO1xuICAgICAgICBpZihuZXh0RW50cnkuZG9uZSA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICByZXN1bHQgPSBjYWxsYmFjay5jYWxsKHRoaXNwLCByZXN1bHQsIG5leHRFbnRyeS52YWx1ZSwgaSwgc2VsZik7XG4gICAgICAgIGkrKztcbiAgICB9XG5cbn07XG5cbkl0ZXJhdG9yLnByb3RvdHlwZS5jb25jYXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIEl0ZXJhdG9yLmNvbmNhdChcbiAgICAgICAgQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpXG4gICAgKTtcbn07XG5cbkl0ZXJhdG9yLnByb3RvdHlwZS5kcm9wV2hpbGUgPSBmdW5jdGlvbiAoY2FsbGJhY2sgLyosIHRoaXNwICovKSB7XG4gICAgdmFyIHNlbGYgPSBJdGVyYXRvcih0aGlzKSxcbiAgICAgICAgdGhpc3AgPSBhcmd1bWVudHNbMV0sXG4gICAgICAgIHN0b3BwZWQgPSBmYWxzZSxcbiAgICAgICAgc3RvcFZhbHVlLFxuICAgICAgICBuZXh0RW50cnksXG4gICAgICAgIGkgPSAwO1xuXG4gICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjYWxsYmFjaykgIT0gXCJbb2JqZWN0IEZ1bmN0aW9uXVwiKVxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7XG5cbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICBuZXh0RW50cnkgPSBzZWxmLm5leHQoKTtcbiAgICAgICAgaWYobmV4dEVudHJ5LmRvbmUgPT09IHRydWUpIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGlmICghY2FsbGJhY2suY2FsbCh0aGlzcCwgbmV4dEVudHJ5LnZhbHVlLCBpLCBzZWxmKSkge1xuICAgICAgICAgICAgc3RvcHBlZCA9IHRydWU7XG4gICAgICAgICAgICBzdG9wVmFsdWUgPSBuZXh0RW50cnkudmFsdWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpKys7XG4gICAgfVxuXG4gICAgaWYgKHN0b3BwZWQpIHtcbiAgICAgICAgcmV0dXJuIHNlbGYuY29uc3RydWN0b3IoW3N0b3BWYWx1ZV0pLmNvbmNhdChzZWxmKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gc2VsZi5jb25zdHJ1Y3RvcihbXSk7XG4gICAgfVxufTtcblxuSXRlcmF0b3IucHJvdG90eXBlLnRha2VXaGlsZSA9IGZ1bmN0aW9uIChjYWxsYmFjayAvKiwgdGhpc3AqLykge1xuICAgIHZhciBzZWxmID0gSXRlcmF0b3IodGhpcyksXG4gICAgICAgIHRoaXNwID0gYXJndW1lbnRzWzFdLFxuICAgICAgICBuZXh0RW50cnksXG4gICAgICAgIGkgPSAwO1xuXG4gICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjYWxsYmFjaykgIT0gXCJbb2JqZWN0IEZ1bmN0aW9uXVwiKVxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7XG5cbiAgICByZXR1cm4gbmV3IHNlbGYuY29uc3RydWN0b3IoZnVuY3Rpb24gKCkge1xuICAgICAgICBpZihzZWxmLl9pdGVyYXRpb25PYmplY3QuZG9uZSAhPT0gdHJ1ZSkge1xuICAgICAgICAgICAgdmFyIHZhbHVlID0gc2VsZi5uZXh0KCkudmFsdWU7XG4gICAgICAgICAgICBpZihjYWxsYmFjay5jYWxsKHRoaXNwLCB2YWx1ZSwgaSsrLCBzZWxmKSkge1xuICAgICAgICAgICAgICAgIHNlbGYuX2l0ZXJhdGlvbk9iamVjdC52YWx1ZSA9IHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgc2VsZi5faXRlcmF0aW9uT2JqZWN0LmRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHNlbGYuX2l0ZXJhdGlvbk9iamVjdC52YWx1ZSA9IHZvaWQgMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2VsZi5faXRlcmF0aW9uT2JqZWN0O1xuICAgIH0pO1xuXG59O1xuXG5JdGVyYXRvci5wcm90b3R5cGUuemlwSXRlcmF0b3IgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIEl0ZXJhdG9yLnVuemlwKFxuICAgICAgICBBcnJheS5wcm90b3R5cGUuY29uY2F0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cylcbiAgICApO1xufTtcblxuSXRlcmF0b3IucHJvdG90eXBlLmVudW1lcmF0ZUl0ZXJhdG9yID0gZnVuY3Rpb24gKHN0YXJ0KSB7XG4gICAgcmV0dXJuIEl0ZXJhdG9yLmNvdW50KHN0YXJ0KS56aXBJdGVyYXRvcih0aGlzKTtcbn07XG5cbi8vIGNyZWF0ZXMgYW4gaXRlcmF0b3IgZm9yIEFycmF5IGFuZCBTdHJpbmdcbkl0ZXJhdG9yLml0ZXJhdGUgPSBmdW5jdGlvbiAoaXRlcmFibGUpIHtcbiAgICB2YXIgc3RhcnQ7XG4gICAgc3RhcnQgPSAwO1xuICAgIHJldHVybiBuZXcgSXRlcmF0b3IoZnVuY3Rpb24gKCkge1xuICAgICAgICAvLyBhZHZhbmNlIHRvIG5leHQgb3duZWQgZW50cnlcbiAgICAgICAgaWYgKHR5cGVvZiBpdGVyYWJsZSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgd2hpbGUgKCEoc3RhcnQgaW4gaXRlcmFibGUpKSB7XG4gICAgICAgICAgICAgICAgLy8gZGVsaWJlcmF0ZWx5IGxhdGUgYm91bmRcbiAgICAgICAgICAgICAgICBpZiAoc3RhcnQgPj0gaXRlcmFibGUubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2l0ZXJhdGlvbk9iamVjdC5kb25lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5faXRlcmF0aW9uT2JqZWN0LnZhbHVlID0gdm9pZCAwO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBzdGFydCArPSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0ID49IGl0ZXJhYmxlLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5faXRlcmF0aW9uT2JqZWN0LmRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5faXRlcmF0aW9uT2JqZWN0LnZhbHVlID0gdm9pZCAwO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYoIXRoaXMuX2l0ZXJhdGlvbk9iamVjdC5kb25lKSB7XG4gICAgICAgICAgICB0aGlzLl9pdGVyYXRpb25PYmplY3QudmFsdWUgPSBpdGVyYWJsZVtzdGFydF07XG4gICAgICAgICAgICBzdGFydCArPSAxO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9pdGVyYXRpb25PYmplY3Q7XG4gICAgfSk7XG59O1xuXG5JdGVyYXRvci5jeWNsZSA9IGZ1bmN0aW9uIChjeWNsZSwgdGltZXMpIHtcbiAgICB2YXIgbmV4dDtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpXG4gICAgICAgIHRpbWVzID0gSW5maW5pdHk7XG4gICAgLy9jeWNsZSA9IEl0ZXJhdG9yKGN5Y2xlKS50b0FycmF5KCk7XG4gICAgcmV0dXJuIG5ldyBJdGVyYXRvcihmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBpdGVyYXRpb24sIG5leHRFbnRyeTtcblxuICAgICAgICBpZihuZXh0KSB7XG4gICAgICAgICAgICBuZXh0RW50cnkgPSBuZXh0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZighbmV4dCB8fCBuZXh0RW50cnkuZG9uZSA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgaWYgKHRpbWVzID4gMCkge1xuICAgICAgICAgICAgICAgIHRpbWVzLS07XG4gICAgICAgICAgICAgICAgaXRlcmF0aW9uID0gSXRlcmF0b3IuaXRlcmF0ZShjeWNsZSk7XG4gICAgICAgICAgICAgICAgbmV4dEVudHJ5ID0gKG5leHQgPSBpdGVyYXRpb24ubmV4dC5iaW5kKGl0ZXJhdGlvbikpKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9pdGVyYXRpb25PYmplY3QuZG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgbmV4dEVudHJ5ID0gdGhpcy5faXRlcmF0aW9uT2JqZWN0OyAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV4dEVudHJ5O1xuICAgIH0pO1xufTtcblxuSXRlcmF0b3IuY29uY2F0ID0gZnVuY3Rpb24gKGl0ZXJhdG9ycykge1xuICAgIGl0ZXJhdG9ycyA9IEl0ZXJhdG9yKGl0ZXJhdG9ycyk7XG4gICAgdmFyIG5leHQ7XG4gICAgcmV0dXJuIG5ldyBJdGVyYXRvcihmdW5jdGlvbiAoKXtcbiAgICAgICAgdmFyIGl0ZXJhdGlvbiwgbmV4dEVudHJ5O1xuICAgICAgICBpZihuZXh0KSBuZXh0RW50cnkgPSBuZXh0KCk7XG4gICAgICAgIGlmKCFuZXh0RW50cnkgfHwgbmV4dEVudHJ5LmRvbmUgPT09IHRydWUpIHtcbiAgICAgICAgICAgIG5leHRFbnRyeSA9IGl0ZXJhdG9ycy5uZXh0KCk7XG4gICAgICAgICAgICBpZihuZXh0RW50cnkuZG9uZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICBpdGVyYXRpb24gPSBJdGVyYXRvcihuZXh0RW50cnkudmFsdWUpO1xuICAgICAgICAgICAgICAgIG5leHQgPSBpdGVyYXRpb24ubmV4dC5iaW5kKGl0ZXJhdGlvbik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXh0RW50cnk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSByZXR1cm4gbmV4dEVudHJ5O1xuICAgIH0pO1xufTtcblxuSXRlcmF0b3IudW56aXAgPSBmdW5jdGlvbiAoaXRlcmF0b3JzKSB7XG4gICAgaXRlcmF0b3JzID0gSXRlcmF0b3IoaXRlcmF0b3JzKS5tYXAoSXRlcmF0b3IpO1xuICAgIGlmIChpdGVyYXRvcnMubGVuZ3RoID09PSAwKVxuICAgICAgICByZXR1cm4gbmV3IEl0ZXJhdG9yKFtdKTtcbiAgICByZXR1cm4gbmV3IEl0ZXJhdG9yKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHN0b3BwZWQsIG5leHRFbnRyeTtcbiAgICAgICAgdmFyIHJlc3VsdCA9IGl0ZXJhdG9ycy5tYXAoZnVuY3Rpb24gKGl0ZXJhdG9yKSB7XG4gICAgICAgICAgICBuZXh0RW50cnkgPSBpdGVyYXRvci5uZXh0KCk7XG4gICAgICAgICAgICBpZiAobmV4dEVudHJ5LmRvbmUgPT09IHRydWUgKSB7XG4gICAgICAgICAgICAgICAgc3RvcHBlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbmV4dEVudHJ5LnZhbHVlO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHN0b3BwZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2l0ZXJhdGlvbk9iamVjdC5kb25lID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuX2l0ZXJhdGlvbk9iamVjdC52YWx1ZSA9IHZvaWQgMDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2l0ZXJhdGlvbk9iamVjdC52YWx1ZSA9IHJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5faXRlcmF0aW9uT2JqZWN0O1xuICAgIH0pO1xufTtcblxuSXRlcmF0b3IuemlwID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBJdGVyYXRvci51bnppcChcbiAgICAgICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKVxuICAgICk7XG59O1xuXG5JdGVyYXRvci5jaGFpbiA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gSXRlcmF0b3IuY29uY2F0KFxuICAgICAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpXG4gICAgKTtcbn07XG5cbkl0ZXJhdG9yLnJhbmdlID0gZnVuY3Rpb24gKHN0YXJ0LCBzdG9wLCBzdGVwKSB7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7XG4gICAgICAgIHN0ZXAgPSAxO1xuICAgIH1cbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgc3RvcCA9IHN0YXJ0O1xuICAgICAgICBzdGFydCA9IDA7XG4gICAgfVxuICAgIHN0YXJ0ID0gc3RhcnQgfHwgMDtcbiAgICBzdGVwID0gc3RlcCB8fCAxO1xuICAgIHJldHVybiBuZXcgSXRlcmF0b3IoZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAoc3RhcnQgPj0gc3RvcCkge1xuICAgICAgICAgICAgdGhpcy5faXRlcmF0aW9uT2JqZWN0LmRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5faXRlcmF0aW9uT2JqZWN0LnZhbHVlID0gdm9pZCAwO1xuICAgICAgICB9XG4gICAgICAgIHZhciByZXN1bHQgPSBzdGFydDtcbiAgICAgICAgc3RhcnQgKz0gc3RlcDtcbiAgICAgICAgdGhpcy5faXRlcmF0aW9uT2JqZWN0LnZhbHVlID0gcmVzdWx0O1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9pdGVyYXRpb25PYmplY3Q7XG4gICAgfSk7XG59O1xuXG5JdGVyYXRvci5jb3VudCA9IGZ1bmN0aW9uIChzdGFydCwgc3RlcCkge1xuICAgIHJldHVybiBJdGVyYXRvci5yYW5nZShzdGFydCwgSW5maW5pdHksIHN0ZXApO1xufTtcblxuSXRlcmF0b3IucmVwZWF0ID0gZnVuY3Rpb24gKHZhbHVlLCB0aW1lcykge1xuICAgIHJldHVybiBuZXcgSXRlcmF0b3IucmFuZ2UodGltZXMpLm1hcEl0ZXJhdG9yKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0pO1xufTtcbiJdfQ==