"use strict";
var Set = require("./_set");
var PropertyChanges = require("./listen/property-changes");
var RangeChanges = require("./listen/range-changes");
var MapChanges = require("./listen/map-changes");
var GlobalSet;
var SIZE = "size";
if ((global.Set !== void 0) && (typeof global.Set.prototype.values === "function")) {
    GlobalSet = global.Set;
    module.exports = Set;
    // use different strategies for making sets observable between Internet
    // Explorer and other browsers.
    var protoIsSupported = {}.__proto__ === Object.prototype, set_makeObservable;
    if (protoIsSupported) {
        set_makeObservable = function () {
            this.__proto__ = ChangeDispatchSet;
        };
    }
    else {
        set_makeObservable = function () {
            Object.defineProperties(this, observableSetProperties);
        };
    }
    Object.defineProperty(GlobalSet.prototype, "makeObservable", {
        value: set_makeObservable,
        writable: true,
        configurable: true,
        enumerable: false
    });
    var set_clear = GlobalSet.prototype.clear, set_add = GlobalSet.prototype.add, set_delete = GlobalSet.prototype.delete;
    var observableSetProperties = {
        "_dispatchEmptyArray": {
            value: []
        },
        "clear": {
            value: function () {
                var size = this.size, clearing;
                if (size) {
                    this.dispatchBeforeOwnPropertyChange(SIZE, size);
                }
                if (this.dispatchesRangeChanges) {
                    clearing = this.toArray();
                    this.dispatchBeforeRangeChange(this._dispatchEmptyArray, clearing, 0);
                }
                set_clear.call(this);
                if (this.dispatchesRangeChanges) {
                    this.dispatchRangeChange(this._dispatchEmptyArray, clearing, 0);
                }
                if (size) {
                    this.dispatchOwnPropertyChange(SIZE, 0);
                }
            },
            writable: true,
            configurable: true
        },
        "add": {
            value: function (value) {
                if (!this.has(value)) {
                    var index = this.size;
                    var dispatchValueArray = [value];
                    this.dispatchBeforeOwnPropertyChange(SIZE, index);
                    if (this.dispatchesRangeChanges) {
                        this.dispatchBeforeRangeChange(dispatchValueArray, this._dispatchEmptyArray, index);
                    }
                    set_add.call(this, value);
                    if (this.dispatchesRangeChanges) {
                        this.dispatchRangeChange(dispatchValueArray, this._dispatchEmptyArray, index);
                    }
                    this.dispatchOwnPropertyChange(SIZE, index + 1);
                    return true;
                }
                return false;
            },
            writable: true,
            configurable: true
        },
        "delete": {
            value: function (value, index) {
                if (this.has(value)) {
                    var size = this.size;
                    if (index === undefined) {
                        var setIterator = this.values();
                        index = 0;
                        while (setIterator.next().value !== value) {
                            index++;
                        }
                    }
                    this.dispatchBeforeOwnPropertyChange(SIZE, size);
                    var dispatchValueArray = [value];
                    if (this.dispatchesRangeChanges) {
                        this.dispatchBeforeRangeChange(this._dispatchEmptyArray, dispatchValueArray, index);
                    }
                    set_delete.call(this, value);
                    if (this.dispatchesRangeChanges) {
                        this.dispatchRangeChange(this._dispatchEmptyArray, dispatchValueArray, index);
                    }
                    this.dispatchOwnPropertyChange(SIZE, size - 1);
                    return true;
                }
                return false;
            }
        }
    };
    var ChangeDispatchSet = Object.create(GlobalSet.prototype, observableSetProperties);
    Object.defineEach(Set.prototype, PropertyChanges.prototype, false, /*configurable*/ true, /*enumerable*/ false, /*writable*/ true);
    //This is a no-op test in property-changes.js - PropertyChanges.prototype.makePropertyObservable, so might as well not pay the price every time....
    Object.defineProperty(Set.prototype, "makePropertyObservable", {
        value: function () { },
        writable: true,
        configurable: true,
        enumerable: false
    });
    Object.defineEach(Set.prototype, RangeChanges.prototype, false, /*configurable*/ true, /*enumerable*/ false, /*writable*/ true);
    Object.defineEach(Set.prototype, MapChanges.prototype, false, /*configurable*/ true, /*enumerable*/ false, /*writable*/ true);
    //This is really only for testing
    Object.defineProperty(Set, "_setupCollectionSet", {
        value: setupCollectionSet,
        writable: true,
        configurable: true,
        enumerable: false
    });
}
else {
    setupCollectionSet();
}
function setupCollectionSet() {
    var _CollectionsSet = Set.CollectionsSet;
    var CollectionsSet = function CollectionsSet(values, equals, hash, getDefault) {
        return _CollectionsSet._init(CollectionsSet, this, values, equals, hash, getDefault);
    };
    // hack so require("set").Set will work in MontageJS
    CollectionsSet.Set = CollectionsSet;
    CollectionsSet.from = _CollectionsSet.from;
    Set.CollectionsSet = CollectionsSet;
    CollectionsSet.prototype = new _CollectionsSet();
    CollectionsSet.prototype.constructor = CollectionsSet;
    var List = require("./list");
    var FastSet = require("./fast-set");
    CollectionsSet.prototype.Order = List;
    CollectionsSet.prototype.Store = FastSet;
    Object.defineProperty(CollectionsSet.prototype, "_dispatchEmptyArray", {
        value: []
    });
    CollectionsSet.prototype.add = function (value) {
        var node = new this.order.Node(value);
        if (!this.store.has(node)) {
            var index = this.length;
            var dispatchValueArray = [value];
            this.dispatchBeforeOwnPropertyChange(SIZE, index);
            if (this.dispatchesRangeChanges) {
                this.dispatchBeforeRangeChange(dispatchValueArray, this._dispatchEmptyArray, index);
            }
            this.order.add(value);
            node = this.order.head.prev;
            this.store.add(node);
            this.length++;
            if (this.dispatchesRangeChanges) {
                this.dispatchRangeChange(dispatchValueArray, this._dispatchEmptyArray, index);
            }
            this.dispatchOwnPropertyChange(SIZE, index + 1);
            return true;
        }
        return false;
    };
    CollectionsSet.prototype["delete"] = function (value, equals) {
        if (equals) {
            throw new Error("Set#delete does not support second argument: equals");
        }
        var node = new this.order.Node(value);
        if (this.store.has(node)) {
            node = this.store.get(node);
            var dispatchValueArray = [value];
            this.dispatchBeforeOwnPropertyChange(SIZE, this.length);
            if (this.dispatchesRangeChanges) {
                this.dispatchBeforeRangeChange(this._dispatchEmptyArray, dispatchValueArray, node.index);
            }
            this.store["delete"](node); // removes from the set
            this.order.splice(node, 1); // removes the node from the list
            this.length--;
            if (this.dispatchesRangeChanges) {
                this.dispatchRangeChange(this._dispatchEmptyArray, dispatchValueArray, node.index);
            }
            this.dispatchOwnPropertyChange(SIZE, this.length);
            return true;
        }
        return false;
    };
    CollectionsSet.prototype.clear = function () {
        var clearing;
        var length = this.length;
        if (length) {
            this.dispatchBeforeOwnPropertyChange(SIZE, length);
        }
        if (this.dispatchesRangeChanges) {
            clearing = this.toArray();
            this.dispatchBeforeRangeChange(this._dispatchEmptyArray, clearing, 0);
        }
        this._clear();
        if (this.dispatchesRangeChanges) {
            this.dispatchRangeChange(this._dispatchEmptyArray, clearing, 0);
        }
        if (length) {
            this.dispatchOwnPropertyChange(SIZE, 0);
        }
    };
    Object.addEach(Set.CollectionsSet.prototype, PropertyChanges.prototype);
    Object.addEach(Set.CollectionsSet.prototype, RangeChanges.prototype);
    Set.CollectionsSet.prototype.makeObservable = function () {
        this.order.makeObservable();
    };
    module.exports = CollectionsSet;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0LmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJwYWNrYWdlcy9qcy1wcm90b3R5cGVzL3BhY2thZ2VzL2NvbGxlY3Rpb25zL3NldC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUFFYixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDNUIsSUFBSSxlQUFlLEdBQUcsT0FBTyxDQUFDLDJCQUEyQixDQUFDLENBQUM7QUFDM0QsSUFBSSxZQUFZLEdBQUcsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDckQsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDakQsSUFBSSxTQUFTLENBQUM7QUFDZCxJQUFJLElBQUksR0FBRyxNQUFNLENBQUM7QUFHbEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEtBQUssS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLFVBQVUsQ0FBQyxFQUFFO0lBQ2hGLFNBQVMsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO0lBQ3ZCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFBO0lBRXBCLHVFQUF1RTtJQUN2RSwrQkFBK0I7SUFDL0IsSUFBSSxnQkFBZ0IsR0FBRyxFQUFFLENBQUMsU0FBUyxLQUFLLE1BQU0sQ0FBQyxTQUFTLEVBQ3BELGtCQUFrQixDQUFDO0lBRXZCLElBQUksZ0JBQWdCLEVBQUU7UUFDbEIsa0JBQWtCLEdBQUc7WUFDakIsSUFBSSxDQUFDLFNBQVMsR0FBRyxpQkFBaUIsQ0FBQztRQUN2QyxDQUFDLENBQUM7S0FDTDtTQUFNO1FBQ0gsa0JBQWtCLEdBQUc7WUFDakIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSx1QkFBdUIsQ0FBQyxDQUFDO1FBQzNELENBQUMsQ0FBQztLQUNMO0lBRUQsTUFBTSxDQUFDLGNB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LE1BQU0sRUFBRSxDQUFDO1FBQ2QsSUFBSSxJQUFJLENBQUMsc0JBQXNCLEVBQUU7WUFDN0IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDbkU7UUFDRCxJQUFJLE1BQU0sRUFBRTtZQUNSLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDM0M7SUFDTCxDQUFDLENBQUM7SUFFRixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsU0FBUyxFQUFFLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN4RSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNyRSxHQUFHLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUc7UUFDMUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUNoQyxDQUFDLENBQUM7SUFFRixNQUFNLENBQUMsT0FBTyxHQUFHLGNBQWMsQ0FBQztBQUNwQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbnZhciBTZXQgPSByZXF1aXJlKFwiLi9fc2V0XCIpO1xudmFyIFByb3BlcnR5Q2hhbmdlcyA9IHJlcXVpcmUoXCIuL2xpc3Rlbi9wcm9wZXJ0eS1jaGFuZ2VzXCIpO1xudmFyIFJhbmdlQ2hhbmdlcyA9IHJlcXVpcmUoXCIuL2xpc3Rlbi9yYW5nZS1jaGFuZ2VzXCIpO1xudmFyIE1hcENoYW5nZXMgPSByZXF1aXJlKFwiLi9saXN0ZW4vbWFwLWNoYW5nZXNcIik7XG52YXIgR2xvYmFsU2V0O1xudmFyIFNJWkUgPSBcInNpemVcIjtcblxuXG5pZiggKGdsb2JhbC5TZXQgIT09IHZvaWQgMCkgJiYgKHR5cGVvZiBnbG9iYWwuU2V0LnByb3RvdHlwZS52YWx1ZXMgPT09IFwiZnVuY3Rpb25cIikpIHtcbiAgICBHbG9iYWxTZXQgPSBnbG9iYWwuU2V0O1xuICAgIG1vZHVsZS5leHBvcnRzID0gU2V0XG5cbiAgICAvLyB1c2UgZGlmZmVyZW50IHN0cmF0ZWdpZXMgZm9yIG1ha2luZyBzZXRzIG9ic2VydmFibGUgYmV0d2VlbiBJbnRlcm5ldFxuICAgIC8vIEV4cGxvcmVyIGFuZCBvdGhlciBicm93c2Vycy5cbiAgICB2YXIgcHJvdG9Jc1N1cHBvcnRlZCA9IHt9Ll9fcHJvdG9fXyA9PT0gT2JqZWN0LnByb3RvdHlwZSxcbiAgICAgICAgc2V0X21ha2VPYnNlcnZhYmxlO1xuXG4gICAgaWYgKHByb3RvSXNTdXBwb3J0ZWQpIHtcbiAgICAgICAgc2V0X21ha2VPYnNlcnZhYmxlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdGhpcy5fX3Byb3RvX18gPSBDaGFuZ2VEaXNwYXRjaFNldDtcbiAgICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzZXRfbWFrZU9ic2VydmFibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCBvYnNlcnZhYmxlU2V0UHJvcGVydGllcyk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEdsb2JhbFNldC5wcm90b3R5cGUsIFwibWFrZU9ic2VydmFibGVcIiwge1xuICAgICAgICB2YWx1ZTogc2V0X21ha2VPYnNlcnZhYmxlLFxuICAgICAgICB3cml0YWJsZTogdHJ1ZSxcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZVxuICAgIH0pO1xuXG4gICAgdmFyIHNldF9jbGVhciA9IEdsb2JhbFNldC5wcm90b3R5cGUuY2xlYXIsXG4gICAgICAgIHNldF9hZGQgPSBHbG9iYWxTZXQucHJvdG90eXBlLmFkZCxcbiAgICAgICAgc2V0X2RlbGV0ZSA9IEdsb2JhbFNldC5wcm90b3R5cGUuZGVsZXRlO1xuXG4gICAgdmFyIG9ic2VydmFibGVTZXRQcm9wZXJ0aWVzID0ge1xuICAgICAgICBcIl9kaXNwYXRjaEVtcHR5QXJyYXlcIjoge1xuICAgICAgICAgICAgdmFsdWU6IFtdXG4gICAgICAgIH0sXG4gICAgICAgIFwiY2xlYXJcIjoge1xuICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2l6ZSA9IHRoaXMuc2l6ZSxcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJpbmc7XG4gICAgICAgICAgICAgICAgaWYgKHNpemUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEJlZm9yZU93blByb3BlcnR5Q2hhbmdlKFNJWkUsIHNpemUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVzUmFuZ2VDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFyaW5nID0gdGhpcy50b0FycmF5KCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hCZWZvcmVSYW5nZUNoYW5nZSh0aGlzLl9kaXNwYXRjaEVtcHR5QXJyYXksIGNsZWFyaW5nLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgc2V0X2NsZWFyLmNhbGwodGhpcyk7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVzUmFuZ2VDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hSYW5nZUNoYW5nZSh0aGlzLl9kaXNwYXRjaEVtcHR5QXJyYXksIGNsZWFyaW5nLCAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHNpemUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaE93blByb3BlcnR5Q2hhbmdlKFNJWkUsIDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxuXG4gICAgICAgIH0sXG4gICAgICAgIFwiYWRkXCI6IHtcbiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFzKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLnNpemU7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkaXNwYXRjaFZhbHVlQXJyYXkgPSBbdmFsdWVdO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoQmVmb3JlT3duUHJvcGVydHlDaGFuZ2UoU0laRSwgaW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVzUmFuZ2VDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoQmVmb3JlUmFuZ2VDaGFuZ2UoZGlzcGF0Y2hWYWx1ZUFycmF5LCB0aGlzLl9kaXNwYXRjaEVtcHR5QXJyYXksIGluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHNldF9hZGQuY2FsbCh0aGlzLHZhbHVlKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVzUmFuZ2VDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoUmFuZ2VDaGFuZ2UoZGlzcGF0Y2hWYWx1ZUFycmF5LCB0aGlzLl9kaXNwYXRjaEVtcHR5QXJyYXksIGluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoT3duUHJvcGVydHlDaGFuZ2UoU0laRSwgaW5kZXggKyAxKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxuICAgICAgICB9LFxuXG4gICAgICAgIFwiZGVsZXRlXCI6IHtcbiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiAodmFsdWUsaW5kZXgpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXModmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzaXplID0gdGhpcy5zaXplO1xuICAgICAgICAgICAgICAgICAgICBpZihpbmRleCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2V0SXRlcmF0b3IgPSB0aGlzLnZhbHVlcygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSAwXG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShzZXRJdGVyYXRvci5uZXh0KCkudmFsdWUgIT09IHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgrKztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoQmVmb3JlT3duUHJvcGVydHlDaGFuZ2UoU0laRSwgc2l6ZSk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkaXNwYXRjaFZhbHVlQXJyYXkgPSBbdmFsdWVdO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVzUmFuZ2VDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoQmVmb3JlUmFuZ2VDaGFuZ2UodGhpcy5fZGlzcGF0Y2hFbXB0eUFycmF5LCBkaXNwYXRjaFZhbHVlQXJyYXksIGluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHNldF9kZWxldGUuY2FsbCh0aGlzLCB2YWx1ZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGlzcGF0Y2hlc1JhbmdlQ2hhbmdlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFJhbmdlQ2hhbmdlKHRoaXMuX2Rpc3BhdGNoRW1wdHlBcnJheSwgZGlzcGF0Y2hWYWx1ZUFycmF5LCBpbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaE93blByb3BlcnR5Q2hhbmdlKFNJWkUsIHNpemUgLSAxKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB2YXIgQ2hhbmdlRGlzcGF0Y2hTZXQgPSBPYmplY3QuY3JlYXRlKEdsb2JhbFNldC5wcm90b3R5cGUsIG9ic2VydmFibGVTZXRQcm9wZXJ0aWVzKTtcblxuXG4gICAgT2JqZWN0LmRlZmluZUVhY2goU2V0LnByb3RvdHlwZSwgUHJvcGVydHlDaGFuZ2VzLnByb3RvdHlwZSwgZmFsc2UsIC8qY29uZmlndXJhYmxlKi90cnVlLCAvKmVudW1lcmFibGUqLyBmYWxzZSwgLyp3cml0YWJsZSovdHJ1ZSk7XG4gICAgLy9UaGlzIGlzIGEgbm8tb3AgdGVzdCBpbiBwcm9wZXJ0eS1jaGFuZ2VzLmpzIC0gUHJvcGVydHlDaGFuZ2VzLnByb3RvdHlwZS5tYWtlUHJvcGVydHlPYnNlcnZhYmxlLCBzbyBtaWdodCBhcyB3ZWxsIG5vdCBwYXkgdGhlIHByaWNlIGV2ZXJ5IHRpbWUuLi4uXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNldC5wcm90b3R5cGUsIFwibWFrZVByb3BlcnR5T2JzZXJ2YWJsZVwiLCB7XG4gICAgICAgIHZhbHVlOiBmdW5jdGlvbigpe30sXG4gICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlXG4gICAgfSk7XG5cbiAgICBPYmplY3QuZGVmaW5lRWFjaChTZXQucHJvdG90eXBlLCBSYW5nZUNoYW5nZXMucHJvdG90eXBlLCBmYWxzZSwgLypjb25maWd1cmFibGUqL3RydWUsIC8qZW51bWVyYWJsZSovIGZhbHNlLCAvKndyaXRhYmxlKi90cnVlKTtcbiAgICBPYmplY3QuZGVmaW5lRWFjaChTZXQucHJvdG90eXBlLCBNYXBDaGFuZ2VzLnByb3RvdHlwZSwgZmFsc2UsIC8qY29uZmlndXJhYmxlKi90cnVlLCAvKmVudW1lcmFibGUqLyBmYWxzZSwgLyp3cml0YWJsZSovdHJ1ZSk7XG5cbiAgICAvL1RoaXMgaXMgcmVhbGx5IG9ubHkgZm9yIHRlc3RpbmdcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2V0LCBcIl9zZXR1cENvbGxlY3Rpb25TZXRcIiwge1xuICAgICAgICB2YWx1ZTogc2V0dXBDb2xsZWN0aW9uU2V0LFxuICAgICAgICB3cml0YWJsZTogdHJ1ZSxcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZVxuICAgIH0pO1xuXG59XG5lbHNlIHtcbiAgICBzZXR1cENvbGxlY3Rpb25TZXQoKTtcbn1cblxuZnVuY3Rpb24gc2V0dXBDb2xsZWN0aW9uU2V0KCkge1xuICAgIHZhciBfQ29sbGVjdGlvbnNTZXQgPSBTZXQuQ29sbGVjdGlvbnNTZXQ7XG5cbiAgICB2YXIgQ29sbGVjdGlvbnNTZXQgPSBmdW5jdGlvbiBDb2xsZWN0aW9uc1NldCh2YWx1ZXMsIGVxdWFscywgaGFzaCwgZ2V0RGVmYXVsdCkge1xuICAgICAgICByZXR1cm4gX0NvbGxlY3Rpb25zU2V0Ll9pbml0KENvbGxlY3Rpb25zU2V0LCB0aGlzLCB2YWx1ZXMsIGVxdWFscywgaGFzaCwgZ2V0RGVmYXVsdCk7XG4gICAgfVxuXG4gICAgLy8gaGFjayBzbyByZXF1aXJlKFwic2V0XCIpLlNldCB3aWxsIHdvcmsgaW4gTW9udGFnZUpTXG4gICAgQ29sbGVjdGlvbnNTZXQuU2V0ID0gQ29sbGVjdGlvbnNTZXQ7XG4gICAgQ29sbGVjdGlvbnNTZXQuZnJvbSA9IF9Db2xsZWN0aW9uc1NldC5mcm9tO1xuICAgIFNldC5Db2xsZWN0aW9uc1NldCA9IENvbGxlY3Rpb25zU2V0O1xuXG4gICAgQ29sbGVjdGlvbnNTZXQucHJvdG90eXBlID0gbmV3IF9Db2xsZWN0aW9uc1NldCgpO1xuICAgIENvbGxlY3Rpb25zU2V0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbGxlY3Rpb25zU2V0O1xuXG4gICAgdmFyIExpc3QgPSByZXF1aXJlKFwiLi9saXN0XCIpO1xuICAgIHZhciBGYXN0U2V0ID0gcmVxdWlyZShcIi4vZmFzdC1zZXRcIik7XG4gICAgQ29sbGVjdGlvbnNTZXQucHJvdG90eXBlLk9yZGVyID0gTGlzdDtcbiAgICBDb2xsZWN0aW9uc1NldC5wcm90b3R5cGUuU3RvcmUgPSBGYXN0U2V0O1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENvbGxlY3Rpb25zU2V0LnByb3RvdHlwZSxcIl9kaXNwYXRjaEVtcHR5QXJyYXlcIiwge1xuICAgICAgICB2YWx1ZTogW11cbiAgICB9KTtcblxuICAgIENvbGxlY3Rpb25zU2V0LnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgdmFyIG5vZGUgPSBuZXcgdGhpcy5vcmRlci5Ob2RlKHZhbHVlKTtcbiAgICAgICAgaWYgKCF0aGlzLnN0b3JlLmhhcyhub2RlKSkge1xuICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5sZW5ndGg7XG4gICAgICAgICAgICB2YXIgZGlzcGF0Y2hWYWx1ZUFycmF5ID0gW3ZhbHVlXTtcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hCZWZvcmVPd25Qcm9wZXJ0eUNoYW5nZShTSVpFLCBpbmRleCk7XG4gICAgICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVzUmFuZ2VDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEJlZm9yZVJhbmdlQ2hhbmdlKGRpc3BhdGNoVmFsdWVBcnJheSwgdGhpcy5fZGlzcGF0Y2hFbXB0eUFycmF5LCBpbmRleCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLm9yZGVyLmFkZCh2YWx1ZSk7XG4gICAgICAgICAgICBub2RlID0gdGhpcy5vcmRlci5oZWFkLnByZXY7XG4gICAgICAgICAgICB0aGlzLnN0b3JlLmFkZChub2RlKTtcbiAgICAgICAgICAgIHRoaXMubGVuZ3RoKys7XG4gICAgICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVzUmFuZ2VDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFJhbmdlQ2hhbmdlKGRpc3BhdGNoVmFsdWVBcnJheSwgdGhpcy5fZGlzcGF0Y2hFbXB0eUFycmF5LCBpbmRleCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmRpc3BhdGNoT3duUHJvcGVydHlDaGFuZ2UoU0laRSwgaW5kZXggKyAxKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9O1xuICAgIENvbGxlY3Rpb25zU2V0LnByb3RvdHlwZVtcImRlbGV0ZVwiXSA9IGZ1bmN0aW9uICh2YWx1ZSwgZXF1YWxzKSB7XG4gICAgICAgIGlmIChlcXVhbHMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlNldCNkZWxldGUgZG9lcyBub3Qgc3VwcG9ydCBzZWNvbmQgYXJndW1lbnQ6IGVxdWFsc1wiKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbm9kZSA9IG5ldyB0aGlzLm9yZGVyLk5vZGUodmFsdWUpO1xuICAgICAgICBpZiAodGhpcy5zdG9yZS5oYXMobm9kZSkpIHtcbiAgICAgICAgICAgIG5vZGUgPSB0aGlzLnN0b3JlLmdldChub2RlKTtcbiAgICAgICAgICAgIHZhciBkaXNwYXRjaFZhbHVlQXJyYXkgPSBbdmFsdWVdO1xuICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEJlZm9yZU93blByb3BlcnR5Q2hhbmdlKFNJWkUsIHRoaXMubGVuZ3RoKTtcbiAgICAgICAgICAgIGlmICh0aGlzLmRpc3BhdGNoZXNSYW5nZUNoYW5nZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoQmVmb3JlUmFuZ2VDaGFuZ2UodGhpcy5fZGlzcGF0Y2hFbXB0eUFycmF5LCBkaXNwYXRjaFZhbHVlQXJyYXksIG5vZGUuaW5kZXgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zdG9yZVtcImRlbGV0ZVwiXShub2RlKTsgLy8gcmVtb3ZlcyBmcm9tIHRoZSBzZXRcbiAgICAgICAgICAgIHRoaXMub3JkZXIuc3BsaWNlKG5vZGUsIDEpOyAvLyByZW1vdmVzIHRoZSBub2RlIGZyb20gdGhlIGxpc3RcbiAgICAgICAgICAgIHRoaXMubGVuZ3RoLS07XG4gICAgICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVzUmFuZ2VDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaFJhbmdlQ2hhbmdlKHRoaXMuX2Rpc3BhdGNoRW1wdHlBcnJheSwgZGlzcGF0Y2hWYWx1ZUFycmF5LCBub2RlLmluZGV4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hPd25Qcm9wZXJ0eUNoYW5nZShTSVpFLCB0aGlzLmxlbmd0aCk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfTtcbiAgICBDb2xsZWN0aW9uc1NldC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBjbGVhcmluZztcbiAgICAgICAgdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoO1xuICAgICAgICBpZiAobGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmRpc3BhdGNoQmVmb3JlT3duUHJvcGVydHlDaGFuZ2UoU0laRSwgbGVuZ3RoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVzUmFuZ2VDaGFuZ2VzKSB7XG4gICAgICAgICAgICBjbGVhcmluZyA9IHRoaXMudG9BcnJheSgpO1xuICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEJlZm9yZVJhbmdlQ2hhbmdlKHRoaXMuX2Rpc3BhdGNoRW1wdHlBcnJheSwgY2xlYXJpbmcsIDApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2NsZWFyKCk7XG4gICAgICAgIGlmICh0aGlzLmRpc3BhdGNoZXNSYW5nZUNoYW5nZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hSYW5nZUNoYW5nZSh0aGlzLl9kaXNwYXRjaEVtcHR5QXJyYXksIGNsZWFyaW5nLCAwKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmRpc3BhdGNoT3duUHJvcGVydHlDaGFuZ2UoU0laRSwgMCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgT2JqZWN0LmFkZEVhY2goU2V0LkNvbGxlY3Rpb25zU2V0LnByb3RvdHlwZSwgUHJvcGVydHlDaGFuZ2VzLnByb3RvdHlwZSk7XG4gICAgT2JqZWN0LmFkZEVhY2goU2V0LkNvbGxlY3Rpb25zU2V0LnByb3RvdHlwZSwgUmFuZ2VDaGFuZ2VzLnByb3RvdHlwZSk7XG4gICAgU2V0LkNvbGxlY3Rpb25zU2V0LnByb3RvdHlwZS5tYWtlT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5vcmRlci5tYWtlT2JzZXJ2YWJsZSgpO1xuICAgIH07XG5cbiAgICBtb2R1bGUuZXhwb3J0cyA9IENvbGxlY3Rpb25zU2V0O1xufVxuXG5cblxuIl19