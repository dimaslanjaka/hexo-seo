"use strict";
// Based on http://dhruvbird.com/lfu.pdf
var Shim = require("./shim");
var Set = require("./set").CollectionsSet;
var GenericCollection = require("./generic-collection");
var GenericSet = require("./generic-set");
var PropertyChanges = require("./listen/property-changes");
var RangeChanges = require("./listen/range-changes");
module.exports = LfuSet;
function LfuSet(values, capacity, equals, hash, getDefault) {
    if (!(this instanceof LfuSet)) {
        return new LfuSet(values, capacity, equals, hash, getDefault);
    }
    capacity = capacity || Infinity;
    equals = equals || Object.equals;
    hash = hash || Object.hash;
    getDefault = getDefault || Function.noop;
    // TODO
    this.store = new Set(undefined, function valueEqual(a, b) {
        return equals(a.value, b.value);
    }, function valueHash(node) {
        return hash(node.value);
    });
    this.frequencyHead = new this.FrequencyNode(0);
    this.contentEquals = equals;
    this.contentHash = hash;
    this.getDefault = getDefault;
    this.capacity = capacity;
    this.length = 0;
    this.addEach(values);
}
LfuSet.LfuSet = LfuSet; // hack so require("lfu-set").LfuSet will work in MontageJS
Object.addEach(LfuSet.prototype, GenericCollection.prototype);
Object.addEach(LfuSet.prototype, GenericSet.prototype);
Object.addEach(LfuSet.prototype, PropertyChanges.prototype);
Object.addEach(LfuSet.prototype, RangeChanges.prototype);
Object.defineProperty(LfuSet.prototype, "size", GenericCollection._sizePropertyDescriptor);
LfuSet.from = GenericCollection.from;
LfuSet.prototype.constructClone = function (values) {
    return new this.constructor(values, this.capacity, this.contentEquals, this.contentHash, this.getDefault);
};
LfuSet.prototype.has = function (value) {
    return this.store.has(new this.Node(value));
};
LfuSet.prototype.get = function (value, equals) {
    if (equals) {
        throw new Error("LfuSet#get does not support second argument: equals");
    }
    var node = this.store.get(new this.Node(value));
    if (node !== undefined) {
        var frequencyNode = node.frequencyNode;
        var nextFrequencyNode = frequencyNode.next;
        if (nextFrequencyNode.frequency !== frequencyNode.frequency + 1) {
            nextFrequencyNode = new this.FrequencyNode(frequencyNode.frequency + 1, frequencyNode, nextFrequencyNode);
        }
        nextFrequencyNode.values.add(node);
        node.frequencyNode = nextFrequencyNode;
        frequencyNode.values["delete"](node);
        if (frequencyNode.values.length === 0) {
            frequencyNode.prev.next = frequencyNode.next;
            frequencyNode.next.prev = frequencyNode.prev;
        }
        return node.value;
    }
    else {
        return this.getDefault(value);
    }
};
LfuSet.prototype.add = function (value) {
    // if the value already exists, get it so that its frequency increases
    if (this.has(value)) {
        this.get(value);
        return false;
    }
    var plus = [], minus = [], leastFrequentNode, leastFrequent;
    if (this.capacity > 0) {
        plus.push(value);
        if (this.length + 1 > this.capacity) {
            leastFrequentNode = this.frequencyHead.next;
            leastFrequent = leastFrequentNode.values.order.head.next.value;
            minus.push(leastFrequent.value);
        }
        if (this.dispatchesRangeChanges) {
            this.dispatchBeforeRangeChange(plus, minus, 0);
        }
        // removal must happen before addition, otherwise we could remove
        // the value we are about to add
        if (minus.length > 0) {
            this.store["delete"](leastFrequent);
            leastFrequentNode.values["delete"](leastFrequent);
            // Don't remove the frequencyNode with value of 1, because we
            // are about to use it again in the addition.
            if (leastFrequentNode.value !== 1 && leastFrequentNode.values.length === 0) {
                this.frequencyHead.next = leastFrequentNode.next;
                leastFrequentNode.next.prev = this.frequencyHead;
            }
        }
        var node = new this.Node(value);
        var frequencyNode = this.frequencyHead.next;
        if (frequencyNode.frequency !== 1) {
            frequencyNode = new this.FrequencyNode(1, this.frequencyHead, frequencyNode);
        }
        this.store.add(node);
        frequencyNode.values.add(node);
        node.frequencyNode = frequencyNode;
        this.length = this.length + plus.length - minus.length;
        if (this.dispatchesRangeChanges) {
            this.dispatchRangeChange(plus, minus, 0);
        }
    }
    // whether it grew
    return plus.length !== minus.length;
};
LfuSet.prototype["delete"] = function (value, equals) {
    if (equals) {
        throw new Error("LfuSet#delete does not support second argument: equals");
    }
    var node = this.store.get(new this.Node(value));
    var found = !!node;
    if (found) {
        if (this.dispatchesRangeChanges) {
            this.dispatchBeforeRangeChange([], [value], 0);
        }
        var frequencyNode = node.frequencyNode;
        this.store["delete"](node);
        frequencyNode.values["delete"](node);
        if (frequencyNode.values.length === 0) {
            frequencyNode.prev.next = frequencyNode.next;
            frequencyNode.next.prev = frequencyNode.prev;
        }
        this.length--;
        if (this.dispatchesRangeChanges) {
            this.dispatchRangeChange([], [value], 0);
        }
    }
    return found;
};
LfuSet.prototype.one = function () {
    if (this.length > 0) {
        return this.frequencyHead.next.values.one().value;
    }
};
LfuSet.prototype.clear = function () {
    this.store.clear();
    this.frequencyHead.next = this.frequencyHead;
    this.length = 0;
};
LfuSet.prototype.reduce = function (callback, basis /*, thisp*/) {
    var thisp = arguments[2];
    var index = 0;
    var frequencyNode = this.frequencyHead.next;
    while (frequencyNode.frequency !== 0) {
        var set = frequencyNode.values;
        basis = set.reduce(function (basis, node) {
            return callback.call(thisp, basis, node.value, index++, this);
        }, basis, this);
        frequencyNode = frequencyNode.next;
    }
    return basis;
};
LfuSet.prototype.reduceRight = function (callback, basis /*, thisp*/) {
    var thisp = arguments[2];
    var index = this.length - 1;
    var frequencyNode = this.frequencyHead.prev;
    while (frequencyNode.frequency !== 0) {
        var set = frequencyNode.values;
        basis = set.reduceRight(function (basis, node) {
            return callback.call(thisp, basis, node.value, index--, this);
        }, basis, this);
        frequencyNode = frequencyNode.prev;
    }
    return basis;
};
LfuSet.prototype.iterate = function () {
    return this.store.map(function (node) {
        return node.value;
    }).iterate();
};
LfuSet.prototype.Node = Node;
function Node(value, frequencyNode) {
    this.value = value;
    this.frequencyNode = frequencyNode;
}
LfuSet.prototype.FrequencyNode = FrequencyNode;
function FrequencyNode(frequency, prev, next) {
    this.frequency = frequency;
    this.values = new Set();
    this.prev = prev || this;
    this.next = next || this;
    if (prev) {
        prev.next = this;
    }
    if (next) {
        next.prev = this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGZ1LXNldC5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsicGFja2FnZXMvanMtcHJvdG90eXBlcy9wYWNrYWdlcy9jb2xsZWN0aW9ucy9sZnUtc2V0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUViLHdDQUF3QztBQUV4QyxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDN0IsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGNBQWMsQ0FBQztBQUMxQyxJQUFJLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ3hELElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUMxQyxJQUFJLGVBQWUsR0FBRyxPQUFPLENBQUMsMkJBQTJCLENBQUMsQ0FBQztBQUMzRCxJQUFJLFlBQVksR0FBRyxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUVyRCxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztBQUV4QixTQUFTLE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsVUFBVTtJQUN0RCxJQUFJLENBQUMsQ0FBQyxJQUFJLFlBQVksTUFBTSxDQUFDLEVBQUU7UUFDM0IsT0FBTyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7S0FDakU7SUFDRCxRQUFRLEdBQUcsUUFBUSxJQUFJLFFBQVEsQ0FBQztJQUNoQyxNQUFNLEdBQUcsTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDakMsSUFBSSxHQUFHLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQzNCLFVBQVUsR0FBRyxVQUFVLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQztJQUV6QyxPQUFPO0lBQ1AsSUFBSSxDQUFDLEtB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QUMsQ0FBQztRQUVoQixhQUFhLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQztLQUN0QztJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2pCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHO0lBQ3ZCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJO1FBQ2hDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUN0QixDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNqQixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFFN0IsU0FBUyxJQUFJLENBQUMsS0FBSyxFQUFFLGFBQWE7SUFDOUIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDbkIsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7QUFDdkMsQ0FBQztBQUVELE1BQU0sQ0FBQyxTQUFTLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztBQUUvQyxTQUFTLGFBQWEsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUk7SUFDeEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7SUFDM0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3hCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxJQUFJLElBQUksQ0FBQztJQUN6QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxJQUFJLENBQUM7SUFDekIsSUFBSSxJQUFJLEVBQUU7UUFDTixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztLQUNwQjtJQUNELElBQUksSUFBSSxFQUFFO1FBQ04sSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7S0FDcEI7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8vIEJhc2VkIG9uIGh0dHA6Ly9kaHJ1dmJpcmQuY29tL2xmdS5wZGZcblxudmFyIFNoaW0gPSByZXF1aXJlKFwiLi9zaGltXCIpO1xudmFyIFNldCA9IHJlcXVpcmUoXCIuL3NldFwiKS5Db2xsZWN0aW9uc1NldDtcbnZhciBHZW5lcmljQ29sbGVjdGlvbiA9IHJlcXVpcmUoXCIuL2dlbmVyaWMtY29sbGVjdGlvblwiKTtcbnZhciBHZW5lcmljU2V0ID0gcmVxdWlyZShcIi4vZ2VuZXJpYy1zZXRcIik7XG52YXIgUHJvcGVydHlDaGFuZ2VzID0gcmVxdWlyZShcIi4vbGlzdGVuL3Byb3BlcnR5LWNoYW5nZXNcIik7XG52YXIgUmFuZ2VDaGFuZ2VzID0gcmVxdWlyZShcIi4vbGlzdGVuL3JhbmdlLWNoYW5nZXNcIik7XG5cbm1vZHVsZS5leHBvcnRzID0gTGZ1U2V0O1xuXG5mdW5jdGlvbiBMZnVTZXQodmFsdWVzLCBjYXBhY2l0eSwgZXF1YWxzLCBoYXNoLCBnZXREZWZhdWx0KSB7XG4gICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIExmdVNldCkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBMZnVTZXQodmFsdWVzLCBjYXBhY2l0eSwgZXF1YWxzLCBoYXNoLCBnZXREZWZhdWx0KTtcbiAgICB9XG4gICAgY2FwYWNpdHkgPSBjYXBhY2l0eSB8fCBJbmZpbml0eTtcbiAgICBlcXVhbHMgPSBlcXVhbHMgfHwgT2JqZWN0LmVxdWFscztcbiAgICBoYXNoID0gaGFzaCB8fCBPYmplY3QuaGFzaDtcbiAgICBnZXREZWZhdWx0ID0gZ2V0RGVmYXVsdCB8fCBGdW5jdGlvbi5ub29wO1xuXG4gICAgLy8gVE9ET1xuICAgIHRoaXMuc3RvcmUgPSBuZXcgU2V0KFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIGZ1bmN0aW9uIHZhbHVlRXF1YWwoYSwgYikge1xuICAgICAgICAgICAgcmV0dXJuIGVxdWFscyhhLnZhbHVlLCBiLnZhbHVlKTtcbiAgICAgICAgfSxcbiAgICAgICAgZnVuY3Rpb24gdmFsdWVIYXNoKG5vZGUpIHtcbiAgICAgICAgICAgIHJldHVybiBoYXNoKG5vZGUudmFsdWUpO1xuICAgICAgICB9XG4gICAgKTtcbiAgICB0aGlzLmZyZXF1ZW5jeUhlYWQgPSBuZXcgdGhpcy5GcmVxdWVuY3lOb2RlKDApO1xuXG4gICAgdGhpcy5jb250ZW50RXF1YWxzID0gZXF1YWxzO1xuICAgIHRoaXMuY29udGVudEhhc2ggPSBoYXNoO1xuICAgIHRoaXMuZ2V0RGVmYXVsdCA9IGdldERlZmF1bHQ7XG4gICAgdGhpcy5jYXBhY2l0eSA9IGNhcGFjaXR5O1xuICAgIHRoaXMubGVuZ3RoID0gMDtcbiAgICB0aGlzLmFkZEVhY2godmFsdWVzKTtcbn1cblxuTGZ1U2V0LkxmdVNldCA9IExmdVNldDsgLy8gaGFjayBzbyByZXF1aXJlKFwibGZ1LXNldFwiKS5MZnVTZXQgd2lsbCB3b3JrIGluIE1vbnRhZ2VKU1xuXG5PYmplY3QuYWRkRWFjaChMZnVTZXQucHJvdG90eXBlLCBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUpO1xuT2JqZWN0LmFkZEVhY2goTGZ1U2V0LnByb3RvdHlwZSwgR2VuZXJpY1NldC5wcm90b3R5cGUpO1xuT2JqZWN0LmFkZEVhY2goTGZ1U2V0LnByb3RvdHlwZSwgUHJvcGVydHlDaGFuZ2VzLnByb3RvdHlwZSk7XG5PYmplY3QuYWRkRWFjaChMZnVTZXQucHJvdG90eXBlLCBSYW5nZUNoYW5nZXMucHJvdG90eXBlKTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShMZnVTZXQucHJvdG90eXBlLFwic2l6ZVwiLEdlbmVyaWNDb2xsZWN0aW9uLl9zaXplUHJvcGVydHlEZXNjcmlwdG9yKTtcbkxmdVNldC5mcm9tID0gR2VuZXJpY0NvbGxlY3Rpb24uZnJvbTtcblxuTGZ1U2V0LnByb3RvdHlwZS5jb25zdHJ1Y3RDbG9uZSA9IGZ1bmN0aW9uICh2YWx1ZXMpIHtcbiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoXG4gICAgICAgIHZhbHVlcyxcbiAgICAgICAgdGhpcy5jYXBhY2l0eSxcbiAgICAgICAgdGhpcy5jb250ZW50RXF1YWxzLFxuICAgICAgICB0aGlzLmNvbnRlbnRIYXNoLFxuICAgICAgICB0aGlzLmdldERlZmF1bHRcbiAgICApO1xufTtcblxuTGZ1U2V0LnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5oYXMobmV3IHRoaXMuTm9kZSh2YWx1ZSkpO1xufTtcblxuTGZ1U2V0LnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAodmFsdWUsIGVxdWFscykge1xuICAgIGlmIChlcXVhbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTGZ1U2V0I2dldCBkb2VzIG5vdCBzdXBwb3J0IHNlY29uZCBhcmd1bWVudDogZXF1YWxzXCIpO1xuICAgIH1cblxuICAgIHZhciBub2RlID0gdGhpcy5zdG9yZS5nZXQobmV3IHRoaXMuTm9kZSh2YWx1ZSkpO1xuICAgIGlmIChub2RlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdmFyIGZyZXF1ZW5jeU5vZGUgPSBub2RlLmZyZXF1ZW5jeU5vZGU7XG4gICAgICAgIHZhciBuZXh0RnJlcXVlbmN5Tm9kZSA9IGZyZXF1ZW5jeU5vZGUubmV4dDtcbiAgICAgICAgaWYgKG5leHRGcmVxdWVuY3lOb2RlLmZyZXF1ZW5jeSAhPT0gZnJlcXVlbmN5Tm9kZS5mcmVxdWVuY3kgKyAxKSB7XG4gICAgICAgICAgICBuZXh0RnJlcXVlbmN5Tm9kZSA9IG5ldyB0aGlzLkZyZXF1ZW5jeU5vZGUoZnJlcXVlbmN5Tm9kZS5mcmVxdWVuY3kgKyAxLCBmcmVxdWVuY3lOb2RlLCBuZXh0RnJlcXVlbmN5Tm9kZSk7XG4gICAgICAgIH1cblxuICAgICAgICBuZXh0RnJlcXVlbmN5Tm9kZS52YWx1ZXMuYWRkKG5vZGUpO1xuICAgICAgICBub2RlLmZyZXF1ZW5jeU5vZGUgPSBuZXh0RnJlcXVlbmN5Tm9kZTtcbiAgICAgICAgZnJlcXVlbmN5Tm9kZS52YWx1ZXNbXCJkZWxldGVcIl0obm9kZSk7XG5cbiAgICAgICAgaWYgKGZyZXF1ZW5jeU5vZGUudmFsdWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgZnJlcXVlbmN5Tm9kZS5wcmV2Lm5leHQgPSBmcmVxdWVuY3lOb2RlLm5leHQ7XG4gICAgICAgICAgICBmcmVxdWVuY3lOb2RlLm5leHQucHJldiA9IGZyZXF1ZW5jeU5vZGUucHJldjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBub2RlLnZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldERlZmF1bHQodmFsdWUpO1xuICAgIH1cbn07XG5cbkxmdVNldC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgLy8gaWYgdGhlIHZhbHVlIGFscmVhZHkgZXhpc3RzLCBnZXQgaXQgc28gdGhhdCBpdHMgZnJlcXVlbmN5IGluY3JlYXNlc1xuICAgIGlmICh0aGlzLmhhcyh2YWx1ZSkpIHtcbiAgICAgICAgdGhpcy5nZXQodmFsdWUpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdmFyIHBsdXMgPSBbXSwgbWludXMgPSBbXSwgbGVhc3RGcmVxdWVudE5vZGUsIGxlYXN0RnJlcXVlbnQ7XG4gICAgaWYgKHRoaXMuY2FwYWNpdHkgPiAwKSB7XG4gICAgICAgIHBsdXMucHVzaCh2YWx1ZSk7XG4gICAgICAgIGlmICh0aGlzLmxlbmd0aCArIDEgPiB0aGlzLmNhcGFjaXR5KSB7XG4gICAgICAgICAgICBsZWFzdEZyZXF1ZW50Tm9kZSA9IHRoaXMuZnJlcXVlbmN5SGVhZC5uZXh0O1xuICAgICAgICAgICAgbGVhc3RGcmVxdWVudCA9IGxlYXN0RnJlcXVlbnROb2RlLnZhbHVlcy5vcmRlci5oZWFkLm5leHQudmFsdWU7XG4gICAgICAgICAgICBtaW51cy5wdXNoKGxlYXN0RnJlcXVlbnQudmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmRpc3BhdGNoZXNSYW5nZUNoYW5nZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hCZWZvcmVSYW5nZUNoYW5nZShwbHVzLCBtaW51cywgMCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyByZW1vdmFsIG11c3QgaGFwcGVuIGJlZm9yZSBhZGRpdGlvbiwgb3RoZXJ3aXNlIHdlIGNvdWxkIHJlbW92ZVxuICAgICAgICAvLyB0aGUgdmFsdWUgd2UgYXJlIGFib3V0IHRvIGFkZFxuICAgICAgICBpZiAobWludXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5zdG9yZVtcImRlbGV0ZVwiXShsZWFzdEZyZXF1ZW50KTtcbiAgICAgICAgICAgIGxlYXN0RnJlcXVlbnROb2RlLnZhbHVlc1tcImRlbGV0ZVwiXShsZWFzdEZyZXF1ZW50KTtcbiAgICAgICAgICAgIC8vIERvbid0IHJlbW92ZSB0aGUgZnJlcXVlbmN5Tm9kZSB3aXRoIHZhbHVlIG9mIDEsIGJlY2F1c2Ugd2VcbiAgICAgICAgICAgIC8vIGFyZSBhYm91dCB0byB1c2UgaXQgYWdhaW4gaW4gdGhlIGFkZGl0aW9uLlxuICAgICAgICAgICAgaWYgKGxlYXN0RnJlcXVlbnROb2RlLnZhbHVlICE9PSAxICYmIGxlYXN0RnJlcXVlbnROb2RlLnZhbHVlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZyZXF1ZW5jeUhlYWQubmV4dCA9IGxlYXN0RnJlcXVlbnROb2RlLm5leHQ7XG4gICAgICAgICAgICAgICAgbGVhc3RGcmVxdWVudE5vZGUubmV4dC5wcmV2ID0gdGhpcy5mcmVxdWVuY3lIZWFkO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdmFyIG5vZGUgPSBuZXcgdGhpcy5Ob2RlKHZhbHVlKTtcbiAgICAgICAgdmFyIGZyZXF1ZW5jeU5vZGUgPSB0aGlzLmZyZXF1ZW5jeUhlYWQubmV4dDtcbiAgICAgICAgaWYgKGZyZXF1ZW5jeU5vZGUuZnJlcXVlbmN5ICE9PSAxKSB7XG4gICAgICAgICAgICBmcmVxdWVuY3lOb2RlID0gbmV3IHRoaXMuRnJlcXVlbmN5Tm9kZSgxLCB0aGlzLmZyZXF1ZW5jeUhlYWQsIGZyZXF1ZW5jeU5vZGUpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RvcmUuYWRkKG5vZGUpO1xuICAgICAgICBmcmVxdWVuY3lOb2RlLnZhbHVlcy5hZGQobm9kZSk7XG4gICAgICAgIG5vZGUuZnJlcXVlbmN5Tm9kZSA9IGZyZXF1ZW5jeU5vZGU7XG5cbiAgICAgICAgdGhpcy5sZW5ndGggPSB0aGlzLmxlbmd0aCArIHBsdXMubGVuZ3RoIC0gbWludXMubGVuZ3RoO1xuXG4gICAgICAgIGlmICh0aGlzLmRpc3BhdGNoZXNSYW5nZUNoYW5nZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hSYW5nZUNoYW5nZShwbHVzLCBtaW51cywgMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB3aGV0aGVyIGl0IGdyZXdcbiAgICByZXR1cm4gcGx1cy5sZW5ndGggIT09IG1pbnVzLmxlbmd0aDtcbn07XG5cbkxmdVNldC5wcm90b3R5cGVbXCJkZWxldGVcIl0gPSBmdW5jdGlvbiAodmFsdWUsIGVxdWFscykge1xuICAgIGlmIChlcXVhbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTGZ1U2V0I2RlbGV0ZSBkb2VzIG5vdCBzdXBwb3J0IHNlY29uZCBhcmd1bWVudDogZXF1YWxzXCIpO1xuICAgIH1cblxuICAgIHZhciBub2RlID0gdGhpcy5zdG9yZS5nZXQobmV3IHRoaXMuTm9kZSh2YWx1ZSkpO1xuICAgIHZhciBmb3VuZCA9ICEhbm9kZTtcbiAgICBpZiAoZm91bmQpIHtcbiAgICAgICAgaWYgKHRoaXMuZGlzcGF0Y2hlc1JhbmdlQ2hhbmdlcykge1xuICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEJlZm9yZVJhbmdlQ2hhbmdlKFtdLCBbdmFsdWVdLCAwKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgZnJlcXVlbmN5Tm9kZSA9IG5vZGUuZnJlcXVlbmN5Tm9kZTtcblxuICAgICAgICB0aGlzLnN0b3JlW1wiZGVsZXRlXCJdKG5vZGUpO1xuICAgICAgICBmcmVxdWVuY3lOb2RlLnZhbHVlc1tcImRlbGV0ZVwiXShub2RlKTtcbiAgICAgICAgaWYgKGZyZXF1ZW5jeU5vZGUudmFsdWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgZnJlcXVlbmN5Tm9kZS5wcmV2Lm5leHQgPSBmcmVxdWVuY3lOb2RlLm5leHQ7XG4gICAgICAgICAgICBmcmVxdWVuY3lOb2RlLm5leHQucHJldiA9IGZyZXF1ZW5jeU5vZGUucHJldjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmxlbmd0aC0tO1xuXG4gICAgICAgIGlmICh0aGlzLmRpc3BhdGNoZXNSYW5nZUNoYW5nZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hSYW5nZUNoYW5nZShbXSwgW3ZhbHVlXSwgMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZm91bmQ7XG59O1xuXG5MZnVTZXQucHJvdG90eXBlLm9uZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZyZXF1ZW5jeUhlYWQubmV4dC52YWx1ZXMub25lKCkudmFsdWU7XG4gICAgfVxufTtcblxuTGZ1U2V0LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnN0b3JlLmNsZWFyKCk7XG4gICAgdGhpcy5mcmVxdWVuY3lIZWFkLm5leHQgPSB0aGlzLmZyZXF1ZW5jeUhlYWQ7XG4gICAgdGhpcy5sZW5ndGggPSAwO1xufTtcblxuTGZ1U2V0LnByb3RvdHlwZS5yZWR1Y2UgPSBmdW5jdGlvbiAoY2FsbGJhY2ssIGJhc2lzIC8qLCB0aGlzcCovKSB7XG4gICAgdmFyIHRoaXNwID0gYXJndW1lbnRzWzJdO1xuICAgIHZhciBpbmRleCA9IDA7XG4gICAgdmFyIGZyZXF1ZW5jeU5vZGUgPSB0aGlzLmZyZXF1ZW5jeUhlYWQubmV4dDtcblxuICAgIHdoaWxlIChmcmVxdWVuY3lOb2RlLmZyZXF1ZW5jeSAhPT0gMCkge1xuICAgICAgICB2YXIgc2V0ID0gZnJlcXVlbmN5Tm9kZS52YWx1ZXM7XG4gICAgICAgIGJhc2lzID0gc2V0LnJlZHVjZShmdW5jdGlvbiAoYmFzaXMsIG5vZGUpIHtcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXNwLCBiYXNpcywgbm9kZS52YWx1ZSwgaW5kZXgrKywgdGhpcyk7XG4gICAgICAgIH0sIGJhc2lzLCB0aGlzKTtcblxuICAgICAgICBmcmVxdWVuY3lOb2RlID0gZnJlcXVlbmN5Tm9kZS5uZXh0O1xuICAgIH1cblxuICAgIHJldHVybiBiYXNpcztcbn07XG5cbkxmdVNldC5wcm90b3R5cGUucmVkdWNlUmlnaHQgPSBmdW5jdGlvbiAoY2FsbGJhY2ssIGJhc2lzIC8qLCB0aGlzcCovKSB7XG4gICAgdmFyIHRoaXNwID0gYXJndW1lbnRzWzJdO1xuICAgIHZhciBpbmRleCA9IHRoaXMubGVuZ3RoIC0gMTtcbiAgICB2YXIgZnJlcXVlbmN5Tm9kZSA9IHRoaXMuZnJlcXVlbmN5SGVhZC5wcmV2O1xuXG4gICAgd2hpbGUgKGZyZXF1ZW5jeU5vZGUuZnJlcXVlbmN5ICE9PSAwKSB7XG4gICAgICAgIHZhciBzZXQgPSBmcmVxdWVuY3lOb2RlLnZhbHVlcztcbiAgICAgICAgYmFzaXMgPSBzZXQucmVkdWNlUmlnaHQoZnVuY3Rpb24gKGJhc2lzLCBub2RlKSB7XG4gICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbCh0aGlzcCwgYmFzaXMsIG5vZGUudmFsdWUsIGluZGV4LS0sIHRoaXMpO1xuICAgICAgICB9LCBiYXNpcywgdGhpcyk7XG5cbiAgICAgICAgZnJlcXVlbmN5Tm9kZSA9IGZyZXF1ZW5jeU5vZGUucHJldjtcbiAgICB9XG5cbiAgICByZXR1cm4gYmFzaXM7XG59O1xuXG5MZnVTZXQucHJvdG90eXBlLml0ZXJhdGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUubWFwKGZ1bmN0aW9uIChub2RlKSB7XG4gICAgICAgIHJldHVybiBub2RlLnZhbHVlO1xuICAgIH0pLml0ZXJhdGUoKTtcbn07XG5cbkxmdVNldC5wcm90b3R5cGUuTm9kZSA9IE5vZGU7XG5cbmZ1bmN0aW9uIE5vZGUodmFsdWUsIGZyZXF1ZW5jeU5vZGUpIHtcbiAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG4gICAgdGhpcy5mcmVxdWVuY3lOb2RlID0gZnJlcXVlbmN5Tm9kZTtcbn1cblxuTGZ1U2V0LnByb3RvdHlwZS5GcmVxdWVuY3lOb2RlID0gRnJlcXVlbmN5Tm9kZTtcblxuZnVuY3Rpb24gRnJlcXVlbmN5Tm9kZShmcmVxdWVuY3ksIHByZXYsIG5leHQpIHtcbiAgICB0aGlzLmZyZXF1ZW5jeSA9IGZyZXF1ZW5jeTtcbiAgICB0aGlzLnZhbHVlcyA9IG5ldyBTZXQoKTtcbiAgICB0aGlzLnByZXYgPSBwcmV2IHx8IHRoaXM7XG4gICAgdGhpcy5uZXh0ID0gbmV4dCB8fCB0aGlzO1xuICAgIGlmIChwcmV2KSB7XG4gICAgICAgIHByZXYubmV4dCA9IHRoaXM7XG4gICAgfVxuICAgIGlmIChuZXh0KSB7XG4gICAgICAgIG5leHQucHJldiA9IHRoaXM7XG4gICAgfVxufVxuIl19