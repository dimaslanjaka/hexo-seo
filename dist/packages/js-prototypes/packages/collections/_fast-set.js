"use strict";
var Shim = require("./shim");
var Dict = require("./_dict");
var List = require("./_list");
var GenericCollection = require("./generic-collection");
var GenericSet = require("./generic-set");
var TreeLog = require("./tree-log");
var object_has = Object.prototype.hasOwnProperty;
module.exports = FastSet;
function FastSet(values, equals, hash, getDefault) {
    if (!(this instanceof FastSet)) {
        return new FastSet(values, equals, hash, getDefault);
    }
    equals = equals || Object.equals;
    hash = hash || Object.hash;
    getDefault = getDefault || Function.noop;
    this.contentEquals = equals;
    this.contentHash = hash;
    this.getDefault = getDefault;
    var self = this;
    this.buckets = new this.Buckets(null, function getDefaultBucket() {
        return new self.Bucket();
    });
    this.length = 0;
    this.addEach(values);
}
FastSet.FastSet = FastSet; // hack so require("fast-set").FastSet will work in MontageJS
Object.addEach(FastSet.prototype, GenericCollection.prototype);
Object.addEach(FastSet.prototype, GenericSet.prototype);
FastSet.from = GenericCollection.from;
FastSet.prototype.Buckets = Dict;
FastSet.prototype.Bucket = List;
FastSet.prototype.constructClone = function (values) {
    return new this.constructor(values, this.contentEquals, this.contentHash, this.getDefault);
};
FastSet.prototype.has = function (value) {
    var hash = this.contentHash(value);
    return this.buckets.get(hash).has(value);
};
FastSet.prototype.get = function (value, equals) {
    if (equals) {
        throw new Error("FastSet#get does not support second argument: equals");
    }
    var hash = this.contentHash(value);
    var buckets = this.buckets;
    if (buckets.has(hash)) {
        return buckets.get(hash).get(value);
    }
    else {
        return this.getDefault(value);
    }
};
FastSet.prototype["delete"] = function (value, equals) {
    if (equals) {
        throw new Error("FastSet#delete does not support second argument: equals");
    }
    var hash = this.contentHash(value);
    var buckets = this.buckets;
    if (buckets.has(hash)) {
        var bucket = buckets.get(hash);
        if (bucket["delete"](value)) {
            this.length--;
            if (bucket.length === 0) {
                buckets["delete"](hash);
            }
            return true;
        }
    }
    return false;
};
FastSet.prototype.clear = function () {
    this.buckets.clear();
    this.length = 0;
};
FastSet.prototype.add = function (value) {
    var hash = this.contentHash(value);
    var buckets = this.buckets;
    if (!buckets.has(hash)) {
        buckets.set(hash, new this.Bucket(null, this.contentEquals));
    }
    if (!buckets.get(hash).has(value)) {
        buckets.get(hash).add(value);
        this.length++;
        return true;
    }
    return false;
};
FastSet.prototype.reduce = function (callback, basis /*, thisp*/) {
    var thisp = arguments[2];
    var buckets = this.buckets;
    var index = 0;
    return buckets.reduce(function (basis, bucket) {
        return bucket.reduce(function (basis, value) {
            return callback.call(thisp, basis, value, index++, this);
        }, basis, this);
    }, basis, this);
};
FastSet.prototype.one = function () {
    if (this.length > 0) {
        return this.buckets.one().one();
    }
};
FastSet.prototype.iterate = function () {
    return this.buckets.valuesArray().flatten().iterate();
};
FastSet.prototype.log = function (charmap, logNode, callback, thisp) {
    charmap = charmap || TreeLog.unicodeSharp;
    logNode = logNode || this.logNode;
    if (!callback) {
        callback = console.log;
        thisp = console;
    }
    callback = callback.bind(thisp);
    var buckets = this.buckets, bucketsSize = buckets.size, mapIter = buckets.keys(), hash, index = 0, branch, leader, bucket;
    while (hash = mapIter.next().value) {
        if (index === bucketsSize - 1) {
            branch = charmap.fromAbove;
            leader = ' ';
        }
        else if (index === 0) {
            branch = charmap.branchDown;
            leader = charmap.strafe;
        }
        else {
            branch = charmap.fromBoth;
            leader = charmap.strafe;
        }
        bucket = buckets.get(hash);
        callback.call(thisp, branch + charmap.through + charmap.branchDown + ' ' + hash);
        bucket.forEach(function (value, node) {
            var branch, below, written;
            if (node === bucket.head.prev) {
                branch = charmap.fromAbove;
                below = ' ';
            }
            else {
                branch = charmap.fromBoth;
                below = charmap.strafe;
            }
            logNode(node, function (line) {
                if (!written) {
                    callback.call(thisp, leader + ' ' + branch + charmap.through + charmap.through + line);
                    written = true;
                }
                else {
                    callback.call(thisp, leader + ' ' + below + '  ' + line);
                }
            }, function (line) {
                callback.call(thisp, leader + ' ' + charmap.strafe + '  ' + line);
            });
        });
        index++;
    }
    //var hashes = buckets.keysArray();
    // hashes.forEach(function (hash, index) {
    //     var branch;
    //     var leader;
    //     if (index === hashes.length - 1) {
    //         branch = charmap.fromAbove;
    //         leader = ' ';
    //     } else if (index === 0) {
    //         branch = charmap.branchDown;
    //         leader = charmap.strafe;
    //     } else {
    //         branch = charmap.fromBoth;
    //         leader = charmap.strafe;
    //     }
    //     var bucket = buckets.get(hash);
    //     callback.call(thisp, branch + charmap.through + charmap.branchDown + ' ' + hash);
    //     bucket.forEach(function (value, node) {
    //         var branch, below;
    //         if (node === bucket.head.prev) {
    //             branch = charmap.fromAbove;
    //             below = ' ';
    //         } else {
    //             branch = charmap.fromBoth;
    //             below = charmap.strafe;
    //         }
    //         var written;
    //         logNode(
    //             node,
    //             function (line) {
    //                 if (!written) {
    //                     callback.call(thisp, leader + ' ' + branch + charmap.through + charmap.through + line);
    //                     written = true;
    //                 } else {
    //                     callback.call(thisp, leader + ' ' + below + '  ' + line);
    //                 }
    //             },
    //             function (line) {
    //                 callback.call(thisp, leader + ' ' + charmap.strafe + '  ' + line);
    //             }
    //         );
    //     });
    // });
};
FastSet.prototype.logNode = function (node, write) {
    var value = node.value;
    if (Object(value) === value) {
        JSON.stringify(value, null, 4).split("\n").forEach(function (line) {
            write(" " + line);
        });
    }
    else {
        write(" " + value);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiX2Zhc3Qtc2V0LmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJwYWNrYWdlcy9qcy1wcm90b3R5cGVzL3BhY2thZ2VzL2NvbGxlY3Rpb25zL19mYXN0LXNldC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUFFYixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDN0IsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzlCLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUM5QixJQUFJLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ3hELElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUMxQyxJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFFcEMsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUM7QUFFakQsTUFBTSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7QUFFekIsU0FBUyxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsVUFBVTtJQUM3QyxJQUFJLENBQUMsQ0FBQyxJQUFJLFlBQVksT0FBTyxDQUFDLEVBQUU7UUFDNUIsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztLQUN4RDtJQUNELE1BQU0sR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNqQyxJQUFJLEdBQUcsSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDM0IsVUFBVSxHQUFHLFVBQVUsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDO0lBQ3pDLElBQUksQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDO0lBQzVCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBQzdCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztJQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsU0FBUyxnQkFBZ0I7UUFDM0QsT0FBTyxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUM3QixDQUFDLENBQUMsQ0FBQztJQUNILElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ2hCLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDekIsQ0FBQztBQUVELE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLENBQUMsNkRBQTZEO0FBRXhGLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMvRCxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3hELE9BQU8sQ0FBQyxJQUFJLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxDQUFDO0FBRXRDLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztBQUNqQyxPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7QUFFaEMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUcsVUFBVSxNQUFNO0lBQy9DLE9BQU8sSUFBSSxJQUFJLENBQUMsV0FBVyxDQUN2QixNQUFNLEVBQ04sSUFBSSxDQUFDLGFBQWEsRUFDbEIsSUFBSSxDQUFDLFdBQVcsRUFDaEIsSUFBSSxDQUFDLFVBQVUsQ0FDbEIsQ0FBQztBQUNOLENBQUMsQ0FBQztBQUVGLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxHQUFHLFVBQVUsS0FBSztJQUNuQyxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzdDLENBQUMsQ0FBQztBQUVGLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxHQUFHLFVBQVUsS0FBSyxFQUFFLE1BQU07SUFDM0MsSUFBSSxNQUFNLEVBQUU7UUFDUixNQUFNLElBQUksS0FBSyxDQUFDLHNEQUFzRCxDQUFDLENBQUM7S0FDM0U7SUFDRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDM0IsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ25CLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7S0FDdkM7U0FBTTtRQUNILE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUNqQztBQUNMLENBQUMsQ0FBQztBQUVGLE9BQU8sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUcsVUFBVSxLQUFLLEVBQUUsTUFBTTtJQUNqRCxJQUFJLE1BQU0sRUFBRTtRQUNSLE1BQU0sSUFBSSxLQUFLLENBQUMseURBQXlELENBQUMsQ0FBQztLQUM5RTtJQUNELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkMsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUMzQixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDbkIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQixJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN6QixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDZCxJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNyQixPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDM0I7WUFDRCxPQUFPLElBQUksQ0FBQztTQUNmO0tBQ0o7SUFDRCxPQUFPLEtBQUssQ0FBQztBQUNqQixDQUFDLENBQUM7QUFFRixPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRztJQUN0QixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ3BCLENBQUMsQ0FBQztBQUVGLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxHQUFHLFVBQVUsS0FBSztJQUNuQyxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztLQUNoRTtJQUNELElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUMvQixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZCxPQUFPLElBQUksQ0FBQztLQUNmO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQyxDQUFDO0FBRUYsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsVUFBVSxRQUFRLEVBQUUsS0FBSyxDQUFDLFdBQVc7SUFDNUQsSUFBSSxLQUFLLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pCLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDM0IsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQVUsS0FBSyxFQUFFLE1BQU07UUFDekMsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsS0FBSyxFQUFFLEtBQUs7WUFDdkMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzdELENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDcEIsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNwQixDQUFDLENBQUM7QUFFRixPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsR0FBRztJQUNwQixJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztLQUNuQztBQUNMLENBQUMsQ0FBQztBQUVGLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHO0lBQ3hCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUMxRCxDQUFDLENBQUM7QUFFRixPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsR0FBRyxVQUFVLE9BQU8sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLEtBQUs7SUFDL0QsT0FBTyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsWUFBWSxDQUFDO0lBQzFDLE9BQU8sR0FBRyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUNsQyxJQUFJLENBQUMsUUFBUSxFQUFFO1FBQ1gsUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7UUFDdkIsS0FBSyxHQUFHLE9BQU8sQ0FBQztLQUNuQjtJQUNELFFBQVEsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRWhDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsV0FBVyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQ2xELE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssR0FBRyxDQUFDLEVBQ3pDLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDO0lBRTNCLE9BQU8sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLEVBQUU7UUFDaEMsSUFBSSxLQUFLLEtBQUssV0FBVyxHQUFHLENBQUMsRUFBRTtZQUMzQixNQUFNLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztZQUMzQixNQUFNLEdBQUcsR0FBRyxDQUFDO1NBQ2hCO2FBQU0sSUFBSSxLQUFLLEtBQUssQ0FBQyxFQUFFO1lBQ3BCLE1BQU0sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDO1lBQzVCLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1NBQzNCO2FBQU07WUFDSCxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUMxQixNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztTQUMzQjtRQUNELE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNCLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLE1BQU0sR0FBRyxPQUFPLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ2pGLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxLQUFLLEVBQUUsSUFBSTtZQUNoQyxJQUFJLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDO1lBQzNCLElBQUksSUFBSSxLQUFLLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUMzQixNQUFNLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztnQkFDM0IsS0FBSyxHQUFHLEdBQUcsQ0FBQzthQUNmO2lCQUFNO2dCQUNILE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDO2dCQUMxQixLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQzthQUMxQjtZQUNELE9BQU8sQ0FDSCxJQUFJLEVBQ0osVUFBVSxJQUFJO2dCQUNWLElBQUksQ0FBQyxPQUFPLEVBQUU7b0JBQ1YsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxHQUFHLEdBQUcsR0FBRyxNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDO29CQUN2RixPQUFPLEdBQUcsSUFBSSxDQUFDO2lCQUNsQjtxQkFBTTtvQkFDSCxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEdBQUcsR0FBRyxHQUFHLEtBQUssR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUM7aUJBQzVEO1lBQ0wsQ0FBQyxFQUNELFVBQVUsSUFBSTtnQkFDVixRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEdBQUcsR0FBRyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ3RFLENBQUMsQ0FDSixDQUFDO1FBQ04sQ0FBQyxDQUFDLENBQUM7UUFDSCxLQUFLLEVBQUUsQ0FBQztLQUNYO0lBRUQsbUNBQW1DO0lBQ25DLDBDQUEwQztJQUMxQyxrQkFBa0I7SUFDbEIsa0JBQWtCO0lBQ2xCLHlDQUF5QztJQUN6QyxzQ0FBc0M7SUFDdEMsd0JBQXdCO0lBQ3hCLGdDQUFnQztJQUNoQyx1Q0FBdUM7SUFDdkMsbUNBQW1DO0lBQ25DLGVBQWU7SUFDZixxQ0FBcUM7SUFDckMsbUNBQW1DO0lBQ25DLFFBQVE7SUFDUixzQ0FBc0M7SUFDdEMsd0ZBQXdGO0lBQ3hGLDhDQUE4QztJQUM5Qyw2QkFBNkI7SUFDN0IsMkNBQTJDO0lBQzNDLDBDQUEwQztJQUMxQywyQkFBMkI7SUFDM0IsbUJBQW1CO0lBQ25CLHlDQUF5QztJQUN6QyxzQ0FBc0M7SUFDdEMsWUFBWTtJQUNaLHVCQUF1QjtJQUN2QixtQkFBbUI7SUFDbkIsb0JBQW9CO0lBQ3BCLGdDQUFnQztJQUNoQyxrQ0FBa0M7SUFDbEMsOEdBQThHO0lBQzlHLHNDQUFzQztJQUN0QywyQkFBMkI7SUFDM0IsZ0ZBQWdGO0lBQ2hGLG9CQUFvQjtJQUNwQixpQkFBaUI7SUFDakIsZ0NBQWdDO0lBQ2hDLHFGQUFxRjtJQUNyRixnQkFBZ0I7SUFDaEIsYUFBYTtJQUNiLFVBQVU7SUFDVixNQUFNO0FBQ1YsQ0FBQyxDQUFDO0FBRUYsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsVUFBVSxJQUFJLEVBQUUsS0FBSztJQUM3QyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3ZCLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLEtBQUssRUFBRTtRQUN6QixJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQUk7WUFDN0QsS0FBSyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUN0QixDQUFDLENBQUMsQ0FBQztLQUNOO1NBQU07UUFDSCxLQUFLLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFDO0tBQ3RCO0FBQ0wsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbnZhciBTaGltID0gcmVxdWlyZShcIi4vc2hpbVwiKTtcbnZhciBEaWN0ID0gcmVxdWlyZShcIi4vX2RpY3RcIik7XG52YXIgTGlzdCA9IHJlcXVpcmUoXCIuL19saXN0XCIpO1xudmFyIEdlbmVyaWNDb2xsZWN0aW9uID0gcmVxdWlyZShcIi4vZ2VuZXJpYy1jb2xsZWN0aW9uXCIpO1xudmFyIEdlbmVyaWNTZXQgPSByZXF1aXJlKFwiLi9nZW5lcmljLXNldFwiKTtcbnZhciBUcmVlTG9nID0gcmVxdWlyZShcIi4vdHJlZS1sb2dcIik7XG5cbnZhciBvYmplY3RfaGFzID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTtcblxubW9kdWxlLmV4cG9ydHMgPSBGYXN0U2V0O1xuXG5mdW5jdGlvbiBGYXN0U2V0KHZhbHVlcywgZXF1YWxzLCBoYXNoLCBnZXREZWZhdWx0KSB7XG4gICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIEZhc3RTZXQpKSB7XG4gICAgICAgIHJldHVybiBuZXcgRmFzdFNldCh2YWx1ZXMsIGVxdWFscywgaGFzaCwgZ2V0RGVmYXVsdCk7XG4gICAgfVxuICAgIGVxdWFscyA9IGVxdWFscyB8fCBPYmplY3QuZXF1YWxzO1xuICAgIGhhc2ggPSBoYXNoIHx8IE9iamVjdC5oYXNoO1xuICAgIGdldERlZmF1bHQgPSBnZXREZWZhdWx0IHx8IEZ1bmN0aW9uLm5vb3A7XG4gICAgdGhpcy5jb250ZW50RXF1YWxzID0gZXF1YWxzO1xuICAgIHRoaXMuY29udGVudEhhc2ggPSBoYXNoO1xuICAgIHRoaXMuZ2V0RGVmYXVsdCA9IGdldERlZmF1bHQ7XG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIHRoaXMuYnVja2V0cyA9IG5ldyB0aGlzLkJ1Y2tldHMobnVsbCwgZnVuY3Rpb24gZ2V0RGVmYXVsdEJ1Y2tldCgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBzZWxmLkJ1Y2tldCgpO1xuICAgIH0pO1xuICAgIHRoaXMubGVuZ3RoID0gMDtcbiAgICB0aGlzLmFkZEVhY2godmFsdWVzKTtcbn1cblxuRmFzdFNldC5GYXN0U2V0ID0gRmFzdFNldDsgLy8gaGFjayBzbyByZXF1aXJlKFwiZmFzdC1zZXRcIikuRmFzdFNldCB3aWxsIHdvcmsgaW4gTW9udGFnZUpTXG5cbk9iamVjdC5hZGRFYWNoKEZhc3RTZXQucHJvdG90eXBlLCBHZW5lcmljQ29sbGVjdGlvbi5wcm90b3R5cGUpO1xuT2JqZWN0LmFkZEVhY2goRmFzdFNldC5wcm90b3R5cGUsIEdlbmVyaWNTZXQucHJvdG90eXBlKTtcbkZhc3RTZXQuZnJvbSA9IEdlbmVyaWNDb2xsZWN0aW9uLmZyb207XG5cbkZhc3RTZXQucHJvdG90eXBlLkJ1Y2tldHMgPSBEaWN0O1xuRmFzdFNldC5wcm90b3R5cGUuQnVja2V0ID0gTGlzdDtcblxuRmFzdFNldC5wcm90b3R5cGUuY29uc3RydWN0Q2xvbmUgPSBmdW5jdGlvbiAodmFsdWVzKSB7XG4gICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKFxuICAgICAgICB2YWx1ZXMsXG4gICAgICAgIHRoaXMuY29udGVudEVxdWFscyxcbiAgICAgICAgdGhpcy5jb250ZW50SGFzaCxcbiAgICAgICAgdGhpcy5nZXREZWZhdWx0XG4gICAgKTtcbn07XG5cbkZhc3RTZXQucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHZhciBoYXNoID0gdGhpcy5jb250ZW50SGFzaCh2YWx1ZSk7XG4gICAgcmV0dXJuIHRoaXMuYnVja2V0cy5nZXQoaGFzaCkuaGFzKHZhbHVlKTtcbn07XG5cbkZhc3RTZXQucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uICh2YWx1ZSwgZXF1YWxzKSB7XG4gICAgaWYgKGVxdWFscykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJGYXN0U2V0I2dldCBkb2VzIG5vdCBzdXBwb3J0IHNlY29uZCBhcmd1bWVudDogZXF1YWxzXCIpO1xuICAgIH1cbiAgICB2YXIgaGFzaCA9IHRoaXMuY29udGVudEhhc2godmFsdWUpO1xuICAgIHZhciBidWNrZXRzID0gdGhpcy5idWNrZXRzO1xuICAgIGlmIChidWNrZXRzLmhhcyhoYXNoKSkge1xuICAgICAgICByZXR1cm4gYnVja2V0cy5nZXQoaGFzaCkuZ2V0KHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXREZWZhdWx0KHZhbHVlKTtcbiAgICB9XG59O1xuXG5GYXN0U2V0LnByb3RvdHlwZVtcImRlbGV0ZVwiXSA9IGZ1bmN0aW9uICh2YWx1ZSwgZXF1YWxzKSB7XG4gICAgaWYgKGVxdWFscykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJGYXN0U2V0I2RlbGV0ZSBkb2VzIG5vdCBzdXBwb3J0IHNlY29uZCBhcmd1bWVudDogZXF1YWxzXCIpO1xuICAgIH1cbiAgICB2YXIgaGFzaCA9IHRoaXMuY29udGVudEhhc2godmFsdWUpO1xuICAgIHZhciBidWNrZXRzID0gdGhpcy5idWNrZXRzO1xuICAgIGlmIChidWNrZXRzLmhhcyhoYXNoKSkge1xuICAgICAgICB2YXIgYnVja2V0ID0gYnVja2V0cy5nZXQoaGFzaCk7XG4gICAgICAgIGlmIChidWNrZXRbXCJkZWxldGVcIl0odmFsdWUpKSB7XG4gICAgICAgICAgICB0aGlzLmxlbmd0aC0tO1xuICAgICAgICAgICAgaWYgKGJ1Y2tldC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBidWNrZXRzW1wiZGVsZXRlXCJdKGhhc2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufTtcblxuRmFzdFNldC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5idWNrZXRzLmNsZWFyKCk7XG4gICAgdGhpcy5sZW5ndGggPSAwO1xufTtcblxuRmFzdFNldC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgdmFyIGhhc2ggPSB0aGlzLmNvbnRlbnRIYXNoKHZhbHVlKTtcbiAgICB2YXIgYnVja2V0cyA9IHRoaXMuYnVja2V0cztcbiAgICBpZiAoIWJ1Y2tldHMuaGFzKGhhc2gpKSB7XG4gICAgICAgIGJ1Y2tldHMuc2V0KGhhc2gsIG5ldyB0aGlzLkJ1Y2tldChudWxsLCB0aGlzLmNvbnRlbnRFcXVhbHMpKTtcbiAgICB9XG4gICAgaWYgKCFidWNrZXRzLmdldChoYXNoKS5oYXModmFsdWUpKSB7XG4gICAgICAgIGJ1Y2tldHMuZ2V0KGhhc2gpLmFkZCh2YWx1ZSk7XG4gICAgICAgIHRoaXMubGVuZ3RoKys7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59O1xuXG5GYXN0U2V0LnByb3RvdHlwZS5yZWR1Y2UgPSBmdW5jdGlvbiAoY2FsbGJhY2ssIGJhc2lzIC8qLCB0aGlzcCovKSB7XG4gICAgdmFyIHRoaXNwID0gYXJndW1lbnRzWzJdO1xuICAgIHZhciBidWNrZXRzID0gdGhpcy5idWNrZXRzO1xuICAgIHZhciBpbmRleCA9IDA7XG4gICAgcmV0dXJuIGJ1Y2tldHMucmVkdWNlKGZ1bmN0aW9uIChiYXNpcywgYnVja2V0KSB7XG4gICAgICAgIHJldHVybiBidWNrZXQucmVkdWNlKGZ1bmN0aW9uIChiYXNpcywgdmFsdWUpIHtcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXNwLCBiYXNpcywgdmFsdWUsIGluZGV4KyssIHRoaXMpO1xuICAgICAgICB9LCBiYXNpcywgdGhpcyk7XG4gICAgfSwgYmFzaXMsIHRoaXMpO1xufTtcblxuRmFzdFNldC5wcm90b3R5cGUub25lID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVja2V0cy5vbmUoKS5vbmUoKTtcbiAgICB9XG59O1xuXG5GYXN0U2V0LnByb3RvdHlwZS5pdGVyYXRlID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLmJ1Y2tldHMudmFsdWVzQXJyYXkoKS5mbGF0dGVuKCkuaXRlcmF0ZSgpO1xufTtcblxuRmFzdFNldC5wcm90b3R5cGUubG9nID0gZnVuY3Rpb24gKGNoYXJtYXAsIGxvZ05vZGUsIGNhbGxiYWNrLCB0aGlzcCkge1xuICAgIGNoYXJtYXAgPSBjaGFybWFwIHx8IFRyZWVMb2cudW5pY29kZVNoYXJwO1xuICAgIGxvZ05vZGUgPSBsb2dOb2RlIHx8IHRoaXMubG9nTm9kZTtcbiAgICBpZiAoIWNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrID0gY29uc29sZS5sb2c7XG4gICAgICAgIHRoaXNwID0gY29uc29sZTtcbiAgICB9XG4gICAgY2FsbGJhY2sgPSBjYWxsYmFjay5iaW5kKHRoaXNwKTtcblxuICAgIHZhciBidWNrZXRzID0gdGhpcy5idWNrZXRzLCBidWNrZXRzU2l6ZSA9IGJ1Y2tldHMuc2l6ZSxcbiAgICAgICAgbWFwSXRlciA9IGJ1Y2tldHMua2V5cygpLCBoYXNoLCBpbmRleCA9IDAsXG4gICAgICAgIGJyYW5jaCwgbGVhZGVyLCBidWNrZXQ7XG5cbiAgICB3aGlsZSAoaGFzaCA9IG1hcEl0ZXIubmV4dCgpLnZhbHVlKSB7XG4gICAgICAgIGlmIChpbmRleCA9PT0gYnVja2V0c1NpemUgLSAxKSB7XG4gICAgICAgICAgICBicmFuY2ggPSBjaGFybWFwLmZyb21BYm92ZTtcbiAgICAgICAgICAgIGxlYWRlciA9ICcgJztcbiAgICAgICAgfSBlbHNlIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICAgICAgYnJhbmNoID0gY2hhcm1hcC5icmFuY2hEb3duO1xuICAgICAgICAgICAgbGVhZGVyID0gY2hhcm1hcC5zdHJhZmU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBicmFuY2ggPSBjaGFybWFwLmZyb21Cb3RoO1xuICAgICAgICAgICAgbGVhZGVyID0gY2hhcm1hcC5zdHJhZmU7XG4gICAgICAgIH1cbiAgICAgICAgYnVja2V0ID0gYnVja2V0cy5nZXQoaGFzaCk7XG4gICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc3AsIGJyYW5jaCArIGNoYXJtYXAudGhyb3VnaCArIGNoYXJtYXAuYnJhbmNoRG93biArICcgJyArIGhhc2gpO1xuICAgICAgICBidWNrZXQuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIG5vZGUpIHtcbiAgICAgICAgICAgIHZhciBicmFuY2gsIGJlbG93LCB3cml0dGVuO1xuICAgICAgICAgICAgaWYgKG5vZGUgPT09IGJ1Y2tldC5oZWFkLnByZXYpIHtcbiAgICAgICAgICAgICAgICBicmFuY2ggPSBjaGFybWFwLmZyb21BYm92ZTtcbiAgICAgICAgICAgICAgICBiZWxvdyA9ICcgJztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYnJhbmNoID0gY2hhcm1hcC5mcm9tQm90aDtcbiAgICAgICAgICAgICAgICBiZWxvdyA9IGNoYXJtYXAuc3RyYWZlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbG9nTm9kZShcbiAgICAgICAgICAgICAgICBub2RlLFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChsaW5lKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghd3JpdHRlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzcCwgbGVhZGVyICsgJyAnICsgYnJhbmNoICsgY2hhcm1hcC50aHJvdWdoICsgY2hhcm1hcC50aHJvdWdoICsgbGluZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB3cml0dGVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc3AsIGxlYWRlciArICcgJyArIGJlbG93ICsgJyAgJyArIGxpbmUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAobGluZSkge1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXNwLCBsZWFkZXIgKyAnICcgKyBjaGFybWFwLnN0cmFmZSArICcgICcgKyBsaW5lKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICAgICAgaW5kZXgrKztcbiAgICB9XG5cbiAgICAvL3ZhciBoYXNoZXMgPSBidWNrZXRzLmtleXNBcnJheSgpO1xuICAgIC8vIGhhc2hlcy5mb3JFYWNoKGZ1bmN0aW9uIChoYXNoLCBpbmRleCkge1xuICAgIC8vICAgICB2YXIgYnJhbmNoO1xuICAgIC8vICAgICB2YXIgbGVhZGVyO1xuICAgIC8vICAgICBpZiAoaW5kZXggPT09IGhhc2hlcy5sZW5ndGggLSAxKSB7XG4gICAgLy8gICAgICAgICBicmFuY2ggPSBjaGFybWFwLmZyb21BYm92ZTtcbiAgICAvLyAgICAgICAgIGxlYWRlciA9ICcgJztcbiAgICAvLyAgICAgfSBlbHNlIGlmIChpbmRleCA9PT0gMCkge1xuICAgIC8vICAgICAgICAgYnJhbmNoID0gY2hhcm1hcC5icmFuY2hEb3duO1xuICAgIC8vICAgICAgICAgbGVhZGVyID0gY2hhcm1hcC5zdHJhZmU7XG4gICAgLy8gICAgIH0gZWxzZSB7XG4gICAgLy8gICAgICAgICBicmFuY2ggPSBjaGFybWFwLmZyb21Cb3RoO1xuICAgIC8vICAgICAgICAgbGVhZGVyID0gY2hhcm1hcC5zdHJhZmU7XG4gICAgLy8gICAgIH1cbiAgICAvLyAgICAgdmFyIGJ1Y2tldCA9IGJ1Y2tldHMuZ2V0KGhhc2gpO1xuICAgIC8vICAgICBjYWxsYmFjay5jYWxsKHRoaXNwLCBicmFuY2ggKyBjaGFybWFwLnRocm91Z2ggKyBjaGFybWFwLmJyYW5jaERvd24gKyAnICcgKyBoYXNoKTtcbiAgICAvLyAgICAgYnVja2V0LmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBub2RlKSB7XG4gICAgLy8gICAgICAgICB2YXIgYnJhbmNoLCBiZWxvdztcbiAgICAvLyAgICAgICAgIGlmIChub2RlID09PSBidWNrZXQuaGVhZC5wcmV2KSB7XG4gICAgLy8gICAgICAgICAgICAgYnJhbmNoID0gY2hhcm1hcC5mcm9tQWJvdmU7XG4gICAgLy8gICAgICAgICAgICAgYmVsb3cgPSAnICc7XG4gICAgLy8gICAgICAgICB9IGVsc2Uge1xuICAgIC8vICAgICAgICAgICAgIGJyYW5jaCA9IGNoYXJtYXAuZnJvbUJvdGg7XG4gICAgLy8gICAgICAgICAgICAgYmVsb3cgPSBjaGFybWFwLnN0cmFmZTtcbiAgICAvLyAgICAgICAgIH1cbiAgICAvLyAgICAgICAgIHZhciB3cml0dGVuO1xuICAgIC8vICAgICAgICAgbG9nTm9kZShcbiAgICAvLyAgICAgICAgICAgICBub2RlLFxuICAgIC8vICAgICAgICAgICAgIGZ1bmN0aW9uIChsaW5lKSB7XG4gICAgLy8gICAgICAgICAgICAgICAgIGlmICghd3JpdHRlbikge1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzcCwgbGVhZGVyICsgJyAnICsgYnJhbmNoICsgY2hhcm1hcC50aHJvdWdoICsgY2hhcm1hcC50aHJvdWdoICsgbGluZSk7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICB3cml0dGVuID0gdHJ1ZTtcbiAgICAvLyAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc3AsIGxlYWRlciArICcgJyArIGJlbG93ICsgJyAgJyArIGxpbmUpO1xuICAgIC8vICAgICAgICAgICAgICAgICB9XG4gICAgLy8gICAgICAgICAgICAgfSxcbiAgICAvLyAgICAgICAgICAgICBmdW5jdGlvbiAobGluZSkge1xuICAgIC8vICAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXNwLCBsZWFkZXIgKyAnICcgKyBjaGFybWFwLnN0cmFmZSArICcgICcgKyBsaW5lKTtcbiAgICAvLyAgICAgICAgICAgICB9XG4gICAgLy8gICAgICAgICApO1xuICAgIC8vICAgICB9KTtcbiAgICAvLyB9KTtcbn07XG5cbkZhc3RTZXQucHJvdG90eXBlLmxvZ05vZGUgPSBmdW5jdGlvbiAobm9kZSwgd3JpdGUpIHtcbiAgICB2YXIgdmFsdWUgPSBub2RlLnZhbHVlO1xuICAgIGlmIChPYmplY3QodmFsdWUpID09PSB2YWx1ZSkge1xuICAgICAgICBKU09OLnN0cmluZ2lmeSh2YWx1ZSwgbnVsbCwgNCkuc3BsaXQoXCJcXG5cIikuZm9yRWFjaChmdW5jdGlvbiAobGluZSkge1xuICAgICAgICAgICAgd3JpdGUoXCIgXCIgKyBsaW5lKTtcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgd3JpdGUoXCIgXCIgKyB2YWx1ZSk7XG4gICAgfVxufTtcbiJdfQ==