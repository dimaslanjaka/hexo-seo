"use strict";
// Adapted from Eloquent JavaScript by Marijn Haverbeke
// http://eloquentjavascript.net/appendix2.html
var ArrayChanges = require("./listen/array-changes");
var Shim = require("./shim");
var GenericCollection = require("./generic-collection");
var MapChanges = require("./listen/map-changes");
var RangeChanges = require("./listen/range-changes");
var PropertyChanges = require("./listen/property-changes");
// Max Heap by default.  Comparison can be reversed to produce a Min Heap.
module.exports = Heap;
function Heap(values, equals, compare) {
    if (!(this instanceof Heap)) {
        return new Heap(values, equals, compare);
    }
    this.contentEquals = equals || Object.equals;
    this.contentCompare = compare || Object.compare;
    this.content = [];
    this.length = 0;
    this.addEach(values);
}
Heap.Heap = Heap; // hack so require("heap").Heap will work in MontageJS
Object.addEach(Heap.prototype, GenericCollection.prototype);
Object.addEach(Heap.prototype, PropertyChanges.prototype);
Object.addEach(Heap.prototype, RangeChanges.prototype);
Object.addEach(Heap.prototype, MapChanges.prototype);
Heap.from = GenericCollection.from;
Heap.prototype.constructClone = function (values) {
    return new this.constructor(values, this.contentEquals, this.contentCompare);
};
// TODO variadic
Heap.prototype.push = function (value) {
    this.content.push(value);
    this.float(this.content.length - 1);
    this.length++;
};
Heap.prototype.pop = function () {
    // Store the first value so we can return it later.  This will leave a gap
    // at index 0 that must be filled.
    var result = this.content[0];
    // Remove the value at the end of the array.  The value most be removed
    // from the end to preserve the completness of the tree, despite that the
    // last child is also among the most likely to need to sink back to the
    // bottom.
    var top = this.content.pop();
    // If there are any values remaining, put the last value on the top and
    // let it sink back down.
    if (this.content.length > 0) {
        this.content.set(0, top);
        this.sink(0);
    }
    this.length--;
    return result;
};
Heap.prototype.add = function (value) {
    this.push(value);
};
// indexOf must do a linear search since a binary heap does not preserve a
// strict sort order.  Thus, deletion takes linear time for all values except
// for the max value.
Heap.prototype.indexOf = function (value) {
    for (var index = 0; index < this.length; index++) {
        if (this.contentEquals(this.content[index], value)) {
            return index;
        }
    }
    return -1;
};
Heap.prototype["delete"] = function (value, equals) {
    if (equals) {
        throw new Error("Heap#delete does not support second argument: equals");
    }
    var index = this.indexOf(value);
    if (index === -1)
        return false;
    var top = this.content.pop();
    this.length = this.content.length;
    if (index === this.content.length)
        return true;
    this.content.set(index, top);
    var comparison = this.contentCompare(top, value);
    if (comparison > 0) {
        this.float(index);
    }
    else if (comparison < 0) {
        this.sink(index);
    }
    return true;
};
Heap.prototype.peek = function () {
    if (this.length) {
        return this.content[0];
    }
};
Heap.prototype.max = function () {
    return this.peek();
};
Heap.prototype.one = function () {
    return this.peek();
};
// Brings a value up until its parent is greater than it
Heap.prototype.float = function (index) {
    // Grab the value that is being adjusted
    var value = this.content[index];
    // A value can go no higher that the top: index 0
    while (index > 0) {
        // Compute the parent value's index and fetch it
        var parentIndex = Math.floor((index + 1) / 2) - 1;
        var parent = this.content[parentIndex];
        // If the parent is less than it
        if (this.contentCompare(parent, value) < 0) {
            this.content.set(parentIndex, value);
            this.content.set(index, parent);
        }
        else {
            // Stop propagating if the parent is greater than the value.
            break;
        }
        // Proceed upward
        index = parentIndex;
    }
};
// Brings a value down until its children are both less than it
Heap.prototype.sink = function (index) {
    // Moves a value downward until it is greater than its children.
    var length = this.content.length;
    var value = this.content[index];
    var left, right, leftIndex, rightIndex, swapIndex, needsSwap;
    while (true) {
        // Invariant: the value is at index.
        // Variant: the index proceedes down the tree.
        // Compute the indicies of the children.
        rightIndex = (index + 1) * 2;
        leftIndex = rightIndex - 1;
        // If the left child exists, determine whether it is greater than the
        // parent (value) and thus whether it can be floated upward.
        needsSwap = false;
        if (leftIndex < length) {
            // Look it up and compare it.
            var left = this.content[leftIndex];
            var comparison = this.contentCompare(left, value);
            // If the child is greater than the parent, it can be floated.
            if (comparison > 0) {
                swapIndex = leftIndex;
                needsSwap = true;
            }
        }
        // If the right child exists, determine whether it is greater than the
        // parent (value), or even greater than the left child.
        if (rightIndex < length) {
            var right = this.content[rightIndex];
            var comparison = this.contentCompare(right, needsSwap ? left : value);
            if (comparison > 0) {
                swapIndex = rightIndex;
                needsSwap = true;
            }
        }
        // if there is a child that is less than the value, float the child and
        // sink the value.
        if (needsSwap) {
            this.content.set(index, this.content[swapIndex]);
            this.content.set(swapIndex, value);
            index = swapIndex;
            // and continue sinking
        }
        else {
            // if the children are both less than the value
            break;
        }
    }
};
Heap.prototype.clear = function () {
    this.content.clear();
    this.length = 0;
};
Heap.prototype.reduce = function (callback, basis /*, thisp*/) {
    var thisp = arguments[2];
    return this.content.reduce(function (basis, value, key) {
        return callback.call(thisp, basis, value, key, this);
    }, basis, this);
};
Heap.prototype.reduceRight = function (callback, basis /*, thisp*/) {
    var thisp = arguments[2];
    return this.content.reduceRight(function (basis, value, key) {
        return callback.call(thisp, basis, value, key, this);
    }, basis, this);
};
Heap.prototype.toJSON = function () {
    return this.toArray();
};
Heap.prototype.makeObservable = function () {
    // TODO refactor dispatchers to allow direct forwarding
    this.content.addRangeChangeListener(this, "content");
    this.content.addBeforeRangeChangeListener(this, "content");
    this.content.addMapChangeListener(this, "content");
    this.content.addBeforeMapChangeListener(this, "content");
};
Heap.prototype.handleContentRangeChange = function (plus, minus, index) {
    this.dispatchRangeChange(plus, minus, index);
};
Heap.prototype.handleContentRangeWillChange = function (plus, minus, index) {
    this.dispatchBeforeRangeChange(plus, minus, index);
};
Heap.prototype.handleContentMapChange = function (value, key) {
    this.dispatchMapChange(key, value);
};
Heap.prototype.handleContentMapWillChange = function (value, key) {
    this.dispatchBeforeMapChange(key, value);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVhcC5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsicGFja2FnZXMvanMtcHJvdG90eXBlcy9wYWNrYWdlcy9jb2xsZWN0aW9ucy9oZWFwLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSx1REFBdUQ7QUFDdkQsK0NBQStDO0FBRS9DLElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0FBQ3JELElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM3QixJQUFJLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ3hELElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2pELElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0FBQ3JELElBQUksZUFBZSxHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBRTNELDBFQUEwRTtBQUUxRSxNQUFNLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztBQUV0QixTQUFTLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU87SUFDakMsSUFBSSxDQUFDLENBQUMsSUFBSSxZQUFZLElBQUksQ0FBQyxFQUFFO1FBQ3pCLE9BQU8sSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztLQUM1QztJQUNELElBQUksQ0FBQyxhQUFhLEdBQUcsTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDN0MsSUFBSSxDQUFDLGNBQWMsR0FBRyxPQUFPLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQztJQUNoRCxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztJQUNsQixJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNoQixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3pCLENBQUM7QUFFRCxJ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QUFFLEdBQUc7SUFDNUQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM3QyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vIEFkYXB0ZWQgZnJvbSBFbG9xdWVudCBKYXZhU2NyaXB0IGJ5IE1hcmlqbiBIYXZlcmJla2Vcbi8vIGh0dHA6Ly9lbG9xdWVudGphdmFzY3JpcHQubmV0L2FwcGVuZGl4Mi5odG1sXG5cbnZhciBBcnJheUNoYW5nZXMgPSByZXF1aXJlKFwiLi9saXN0ZW4vYXJyYXktY2hhbmdlc1wiKTtcbnZhciBTaGltID0gcmVxdWlyZShcIi4vc2hpbVwiKTtcbnZhciBHZW5lcmljQ29sbGVjdGlvbiA9IHJlcXVpcmUoXCIuL2dlbmVyaWMtY29sbGVjdGlvblwiKTtcbnZhciBNYXBDaGFuZ2VzID0gcmVxdWlyZShcIi4vbGlzdGVuL21hcC1jaGFuZ2VzXCIpO1xudmFyIFJhbmdlQ2hhbmdlcyA9IHJlcXVpcmUoXCIuL2xpc3Rlbi9yYW5nZS1jaGFuZ2VzXCIpO1xudmFyIFByb3BlcnR5Q2hhbmdlcyA9IHJlcXVpcmUoXCIuL2xpc3Rlbi9wcm9wZXJ0eS1jaGFuZ2VzXCIpO1xuXG4vLyBNYXggSGVhcCBieSBkZWZhdWx0LiAgQ29tcGFyaXNvbiBjYW4gYmUgcmV2ZXJzZWQgdG8gcHJvZHVjZSBhIE1pbiBIZWFwLlxuXG5tb2R1bGUuZXhwb3J0cyA9IEhlYXA7XG5cbmZ1bmN0aW9uIEhlYXAodmFsdWVzLCBlcXVhbHMsIGNvbXBhcmUpIHtcbiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgSGVhcCkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBIZWFwKHZhbHVlcywgZXF1YWxzLCBjb21wYXJlKTtcbiAgICB9XG4gICAgdGhpcy5jb250ZW50RXF1YWxzID0gZXF1YWxzIHx8IE9iamVjdC5lcXVhbHM7XG4gICAgdGhpcy5jb250ZW50Q29tcGFyZSA9IGNvbXBhcmUgfHwgT2JqZWN0LmNvbXBhcmU7XG4gICAgdGhpcy5jb250ZW50ID0gW107XG4gICAgdGhpcy5sZW5ndGggPSAwO1xuICAgIHRoaXMuYWRkRWFjaCh2YWx1ZXMpO1xufVxuXG5IZWFwLkhlYXAgPSBIZWFwOyAvLyBoYWNrIHNvIHJlcXVpcmUoXCJoZWFwXCIpLkhlYXAgd2lsbCB3b3JrIGluIE1vbnRhZ2VKU1xuXG5PYmplY3QuYWRkRWFjaChIZWFwLnByb3RvdHlwZSwgR2VuZXJpY0NvbGxlY3Rpb24ucHJvdG90eXBlKTtcbk9iamVjdC5hZGRFYWNoKEhlYXAucHJvdG90eXBlLCBQcm9wZXJ0eUNoYW5nZXMucHJvdG90eXBlKTtcbk9iamVjdC5hZGRFYWNoKEhlYXAucHJvdG90eXBlLCBSYW5nZUNoYW5nZXMucHJvdG90eXBlKTtcbk9iamVjdC5hZGRFYWNoKEhlYXAucHJvdG90eXBlLCBNYXBDaGFuZ2VzLnByb3RvdHlwZSk7XG5cbkhlYXAuZnJvbSA9IEdlbmVyaWNDb2xsZWN0aW9uLmZyb207XG5cbkhlYXAucHJvdG90eXBlLmNvbnN0cnVjdENsb25lID0gZnVuY3Rpb24gKHZhbHVlcykge1xuICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcihcbiAgICAgICAgdmFsdWVzLFxuICAgICAgICB0aGlzLmNvbnRlbnRFcXVhbHMsXG4gICAgICAgIHRoaXMuY29udGVudENvbXBhcmVcbiAgICApO1xufTtcblxuLy8gVE9ETyB2YXJpYWRpY1xuSGVhcC5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHRoaXMuY29udGVudC5wdXNoKHZhbHVlKTtcbiAgICB0aGlzLmZsb2F0KHRoaXMuY29udGVudC5sZW5ndGggLSAxKTtcbiAgICB0aGlzLmxlbmd0aCsrO1xufTtcblxuSGVhcC5wcm90b3R5cGUucG9wID0gZnVuY3Rpb24gKCkge1xuICAgIC8vIFN0b3JlIHRoZSBmaXJzdCB2YWx1ZSBzbyB3ZSBjYW4gcmV0dXJuIGl0IGxhdGVyLiAgVGhpcyB3aWxsIGxlYXZlIGEgZ2FwXG4gICAgLy8gYXQgaW5kZXggMCB0aGF0IG11c3QgYmUgZmlsbGVkLlxuICAgIHZhciByZXN1bHQgPSB0aGlzLmNvbnRlbnRbMF07XG4gICAgLy8gUmVtb3ZlIHRoZSB2YWx1ZSBhdCB0aGUgZW5kIG9mIHRoZSBhcnJheS4gIFRoZSB2YWx1ZSBtb3N0IGJlIHJlbW92ZWRcbiAgICAvLyBmcm9tIHRoZSBlbmQgdG8gcHJlc2VydmUgdGhlIGNvbXBsZXRuZXNzIG9mIHRoZSB0cmVlLCBkZXNwaXRlIHRoYXQgdGhlXG4gICAgLy8gbGFzdCBjaGlsZCBpcyBhbHNvIGFtb25nIHRoZSBtb3N0IGxpa2VseSB0byBuZWVkIHRvIHNpbmsgYmFjayB0byB0aGVcbiAgICAvLyBib3R0b20uXG4gICAgdmFyIHRvcCA9IHRoaXMuY29udGVudC5wb3AoKTtcbiAgICAvLyBJZiB0aGVyZSBhcmUgYW55IHZhbHVlcyByZW1haW5pbmcsIHB1dCB0aGUgbGFzdCB2YWx1ZSBvbiB0aGUgdG9wIGFuZFxuICAgIC8vIGxldCBpdCBzaW5rIGJhY2sgZG93bi5cbiAgICBpZiAodGhpcy5jb250ZW50Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhpcy5jb250ZW50LnNldCgwLCB0b3ApO1xuICAgICAgICB0aGlzLnNpbmsoMCk7XG4gICAgfVxuICAgIHRoaXMubGVuZ3RoLS07XG4gICAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbkhlYXAucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHRoaXMucHVzaCh2YWx1ZSk7XG59O1xuXG4vLyBpbmRleE9mIG11c3QgZG8gYSBsaW5lYXIgc2VhcmNoIHNpbmNlIGEgYmluYXJ5IGhlYXAgZG9lcyBub3QgcHJlc2VydmUgYVxuLy8gc3RyaWN0IHNvcnQgb3JkZXIuICBUaHVzLCBkZWxldGlvbiB0YWtlcyBsaW5lYXIgdGltZSBmb3IgYWxsIHZhbHVlcyBleGNlcHRcbi8vIGZvciB0aGUgbWF4IHZhbHVlLlxuXG5IZWFwLnByb3RvdHlwZS5pbmRleE9mID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGlmICh0aGlzLmNvbnRlbnRFcXVhbHModGhpcy5jb250ZW50W2luZGV4XSwgdmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gaW5kZXg7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIC0xO1xufTtcblxuSGVhcC5wcm90b3R5cGVbXCJkZWxldGVcIl0gPSBmdW5jdGlvbiAodmFsdWUsIGVxdWFscykge1xuICAgIGlmIChlcXVhbHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSGVhcCNkZWxldGUgZG9lcyBub3Qgc3VwcG9ydCBzZWNvbmQgYXJndW1lbnQ6IGVxdWFsc1wiKTtcbiAgICB9XG4gICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleE9mKHZhbHVlKTtcbiAgICBpZiAoaW5kZXggPT09IC0xKVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgdmFyIHRvcCA9IHRoaXMuY29udGVudC5wb3AoKTtcbiAgICB0aGlzLmxlbmd0aCA9IHRoaXMuY29udGVudC5sZW5ndGg7XG4gICAgaWYgKGluZGV4ID09PSB0aGlzLmNvbnRlbnQubGVuZ3RoKVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB0aGlzLmNvbnRlbnQuc2V0KGluZGV4LCB0b3ApO1xuICAgIHZhciBjb21wYXJpc29uID0gdGhpcy5jb250ZW50Q29tcGFyZSh0b3AsIHZhbHVlKTtcbiAgICBpZiAoY29tcGFyaXNvbiA+IDApIHtcbiAgICAgICAgdGhpcy5mbG9hdChpbmRleCk7XG4gICAgfSBlbHNlIGlmIChjb21wYXJpc29uIDwgMCkge1xuICAgICAgICB0aGlzLnNpbmsoaW5kZXgpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn07XG5cbkhlYXAucHJvdG90eXBlLnBlZWsgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnRbMF07XG4gICAgfVxufTtcblxuSGVhcC5wcm90b3R5cGUubWF4ID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLnBlZWsoKTtcbn07XG5cbkhlYXAucHJvdG90eXBlLm9uZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5wZWVrKCk7XG59O1xuXG4vLyBCcmluZ3MgYSB2YWx1ZSB1cCB1bnRpbCBpdHMgcGFyZW50IGlzIGdyZWF0ZXIgdGhhbiBpdFxuSGVhcC5wcm90b3R5cGUuZmxvYXQgPSBmdW5jdGlvbiAoaW5kZXgpIHtcbiAgICAvLyBHcmFiIHRoZSB2YWx1ZSB0aGF0IGlzIGJlaW5nIGFkanVzdGVkXG4gICAgdmFyIHZhbHVlID0gdGhpcy5jb250ZW50W2luZGV4XTtcbiAgICAvLyBBIHZhbHVlIGNhbiBnbyBubyBoaWdoZXIgdGhhdCB0aGUgdG9wOiBpbmRleCAwXG4gICAgd2hpbGUgKGluZGV4ID4gMCkge1xuICAgICAgICAvLyBDb21wdXRlIHRoZSBwYXJlbnQgdmFsdWUncyBpbmRleCBhbmQgZmV0Y2ggaXRcbiAgICAgICAgdmFyIHBhcmVudEluZGV4ID0gTWF0aC5mbG9vcigoaW5kZXggKyAxKSAvIDIpIC0gMTtcbiAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuY29udGVudFtwYXJlbnRJbmRleF07XG4gICAgICAgIC8vIElmIHRoZSBwYXJlbnQgaXMgbGVzcyB0aGFuIGl0XG4gICAgICAgIGlmICh0aGlzLmNvbnRlbnRDb21wYXJlKHBhcmVudCwgdmFsdWUpIDwgMCkge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50LnNldChwYXJlbnRJbmRleCwgdmFsdWUpO1xuICAgICAgICAgICAgdGhpcy5jb250ZW50LnNldChpbmRleCwgcGFyZW50KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFN0b3AgcHJvcGFnYXRpbmcgaWYgdGhlIHBhcmVudCBpcyBncmVhdGVyIHRoYW4gdGhlIHZhbHVlLlxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgLy8gUHJvY2VlZCB1cHdhcmRcbiAgICAgICAgaW5kZXggPSBwYXJlbnRJbmRleDtcbiAgICB9XG59O1xuXG4vLyBCcmluZ3MgYSB2YWx1ZSBkb3duIHVudGlsIGl0cyBjaGlsZHJlbiBhcmUgYm90aCBsZXNzIHRoYW4gaXRcbkhlYXAucHJvdG90eXBlLnNpbmsgPSBmdW5jdGlvbiAoaW5kZXgpIHtcbiAgICAvLyBNb3ZlcyBhIHZhbHVlIGRvd253YXJkIHVudGlsIGl0IGlzIGdyZWF0ZXIgdGhhbiBpdHMgY2hpbGRyZW4uXG4gICAgdmFyIGxlbmd0aCA9IHRoaXMuY29udGVudC5sZW5ndGg7XG4gICAgdmFyIHZhbHVlID0gdGhpcy5jb250ZW50W2luZGV4XTtcbiAgICB2YXIgbGVmdCwgcmlnaHQsIGxlZnRJbmRleCwgcmlnaHRJbmRleCwgc3dhcEluZGV4LCBuZWVkc1N3YXA7XG5cbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAvLyBJbnZhcmlhbnQ6IHRoZSB2YWx1ZSBpcyBhdCBpbmRleC5cbiAgICAgICAgLy8gVmFyaWFudDogdGhlIGluZGV4IHByb2NlZWRlcyBkb3duIHRoZSB0cmVlLlxuXG4gICAgICAgIC8vIENvbXB1dGUgdGhlIGluZGljaWVzIG9mIHRoZSBjaGlsZHJlbi5cbiAgICAgICAgcmlnaHRJbmRleCA9IChpbmRleCArIDEpICogMjtcbiAgICAgICAgbGVmdEluZGV4ID0gcmlnaHRJbmRleCAtIDE7XG5cbiAgICAgICAgLy8gSWYgdGhlIGxlZnQgY2hpbGQgZXhpc3RzLCBkZXRlcm1pbmUgd2hldGhlciBpdCBpcyBncmVhdGVyIHRoYW4gdGhlXG4gICAgICAgIC8vIHBhcmVudCAodmFsdWUpIGFuZCB0aHVzIHdoZXRoZXIgaXQgY2FuIGJlIGZsb2F0ZWQgdXB3YXJkLlxuICAgICAgICBuZWVkc1N3YXAgPSBmYWxzZTtcbiAgICAgICAgaWYgKGxlZnRJbmRleCA8IGxlbmd0aCkge1xuICAgICAgICAgICAgLy8gTG9vayBpdCB1cCBhbmQgY29tcGFyZSBpdC5cbiAgICAgICAgICAgIHZhciBsZWZ0ID0gdGhpcy5jb250ZW50W2xlZnRJbmRleF07XG4gICAgICAgICAgICB2YXIgY29tcGFyaXNvbiA9IHRoaXMuY29udGVudENvbXBhcmUobGVmdCwgdmFsdWUpO1xuICAgICAgICAgICAgLy8gSWYgdGhlIGNoaWxkIGlzIGdyZWF0ZXIgdGhhbiB0aGUgcGFyZW50LCBpdCBjYW4gYmUgZmxvYXRlZC5cbiAgICAgICAgICAgIGlmIChjb21wYXJpc29uID4gMCkge1xuICAgICAgICAgICAgICAgIHN3YXBJbmRleCA9IGxlZnRJbmRleDtcbiAgICAgICAgICAgICAgICBuZWVkc1N3YXAgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gSWYgdGhlIHJpZ2h0IGNoaWxkIGV4aXN0cywgZGV0ZXJtaW5lIHdoZXRoZXIgaXQgaXMgZ3JlYXRlciB0aGFuIHRoZVxuICAgICAgICAvLyBwYXJlbnQgKHZhbHVlKSwgb3IgZXZlbiBncmVhdGVyIHRoYW4gdGhlIGxlZnQgY2hpbGQuXG4gICAgICAgIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgcmlnaHQgPSB0aGlzLmNvbnRlbnRbcmlnaHRJbmRleF07XG4gICAgICAgICAgICB2YXIgY29tcGFyaXNvbiA9IHRoaXMuY29udGVudENvbXBhcmUocmlnaHQsIG5lZWRzU3dhcCA/IGxlZnQgOiB2YWx1ZSk7XG4gICAgICAgICAgICBpZiAoY29tcGFyaXNvbiA+IDApIHtcbiAgICAgICAgICAgICAgICBzd2FwSW5kZXggPSByaWdodEluZGV4O1xuICAgICAgICAgICAgICAgIG5lZWRzU3dhcCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpZiB0aGVyZSBpcyBhIGNoaWxkIHRoYXQgaXMgbGVzcyB0aGFuIHRoZSB2YWx1ZSwgZmxvYXQgdGhlIGNoaWxkIGFuZFxuICAgICAgICAvLyBzaW5rIHRoZSB2YWx1ZS5cbiAgICAgICAgaWYgKG5lZWRzU3dhcCkge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50LnNldChpbmRleCwgdGhpcy5jb250ZW50W3N3YXBJbmRleF0pO1xuICAgICAgICAgICAgdGhpcy5jb250ZW50LnNldChzd2FwSW5kZXgsIHZhbHVlKTtcbiAgICAgICAgICAgIGluZGV4ID0gc3dhcEluZGV4O1xuICAgICAgICAgICAgLy8gYW5kIGNvbnRpbnVlIHNpbmtpbmdcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIGlmIHRoZSBjaGlsZHJlbiBhcmUgYm90aCBsZXNzIHRoYW4gdGhlIHZhbHVlXG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgfVxuXG59O1xuXG5IZWFwLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmNvbnRlbnQuY2xlYXIoKTtcbiAgICB0aGlzLmxlbmd0aCA9IDA7XG59O1xuXG5IZWFwLnByb3RvdHlwZS5yZWR1Y2UgPSBmdW5jdGlvbiAoY2FsbGJhY2ssIGJhc2lzIC8qLCB0aGlzcCovKSB7XG4gICAgdmFyIHRoaXNwID0gYXJndW1lbnRzWzJdO1xuICAgIHJldHVybiB0aGlzLmNvbnRlbnQucmVkdWNlKGZ1bmN0aW9uIChiYXNpcywgdmFsdWUsIGtleSkge1xuICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbCh0aGlzcCwgYmFzaXMsIHZhbHVlLCBrZXksIHRoaXMpO1xuICAgIH0sIGJhc2lzLCB0aGlzKTtcbn07XG5cbkhlYXAucHJvdG90eXBlLnJlZHVjZVJpZ2h0ID0gZnVuY3Rpb24gKGNhbGxiYWNrLCBiYXNpcyAvKiwgdGhpc3AqLykge1xuICAgIHZhciB0aGlzcCA9IGFyZ3VtZW50c1syXTtcbiAgICByZXR1cm4gdGhpcy5jb250ZW50LnJlZHVjZVJpZ2h0KGZ1bmN0aW9uIChiYXNpcywgdmFsdWUsIGtleSkge1xuICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbCh0aGlzcCwgYmFzaXMsIHZhbHVlLCBrZXksIHRoaXMpO1xuICAgIH0sIGJhc2lzLCB0aGlzKTtcbn07XG5cbkhlYXAucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy50b0FycmF5KCk7XG59O1xuXG5IZWFwLnByb3RvdHlwZS5tYWtlT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAvLyBUT0RPIHJlZmFjdG9yIGRpc3BhdGNoZXJzIHRvIGFsbG93IGRpcmVjdCBmb3J3YXJkaW5nXG4gICAgdGhpcy5jb250ZW50LmFkZFJhbmdlQ2hhbmdlTGlzdGVuZXIodGhpcywgXCJjb250ZW50XCIpO1xuICAgIHRoaXMuY29udGVudC5hZGRCZWZvcmVSYW5nZUNoYW5nZUxpc3RlbmVyKHRoaXMsIFwiY29udGVudFwiKTtcbiAgICB0aGlzLmNvbnRlbnQuYWRkTWFwQ2hhbmdlTGlzdGVuZXIodGhpcywgXCJjb250ZW50XCIpO1xuICAgIHRoaXMuY29udGVudC5hZGRCZWZvcmVNYXBDaGFuZ2VMaXN0ZW5lcih0aGlzLCBcImNvbnRlbnRcIik7XG59O1xuXG5IZWFwLnByb3RvdHlwZS5oYW5kbGVDb250ZW50UmFuZ2VDaGFuZ2UgPSBmdW5jdGlvbiAocGx1cywgbWludXMsIGluZGV4KSB7XG4gICAgdGhpcy5kaXNwYXRjaFJhbmdlQ2hhbmdlKHBsdXMsIG1pbnVzLCBpbmRleCk7XG59O1xuXG5IZWFwLnByb3RvdHlwZS5oYW5kbGVDb250ZW50UmFuZ2VXaWxsQ2hhbmdlID0gZnVuY3Rpb24gKHBsdXMsIG1pbnVzLCBpbmRleCkge1xuICAgIHRoaXMuZGlzcGF0Y2hCZWZvcmVSYW5nZUNoYW5nZShwbHVzLCBtaW51cywgaW5kZXgpO1xufTtcblxuSGVhcC5wcm90b3R5cGUuaGFuZGxlQ29udGVudE1hcENoYW5nZSA9IGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7XG4gICAgdGhpcy5kaXNwYXRjaE1hcENoYW5nZShrZXksIHZhbHVlKTtcbn07XG5cbkhlYXAucHJvdG90eXBlLmhhbmRsZUNvbnRlbnRNYXBXaWxsQ2hhbmdlID0gZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHtcbiAgICB0aGlzLmRpc3BhdGNoQmVmb3JlTWFwQ2hhbmdlKGtleSwgdmFsdWUpO1xufTtcbiJdfQ==